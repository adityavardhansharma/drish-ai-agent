<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocSense - Document Analysis</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              primary: {
                50: '#f0f7ff',
                100: '#e0eefe',
                200: '#bae0fd',
                300: '#7dcbfa',
                400: '#48b0f7',
                500: '#2197ed',
                600: '#0f77d9',
                700: '#0f60b0',
                800: '#134f90',
                900: '#164577',
              },
              neutral: {
                50: '#f9fafb',
                100: '#f3f4f6',
                200: '#e5e7eb',
                300: '#d1d5db',
                400: '#9ca3af',
                500: '#6b7280',
                600: '#4b5563',
                700: '#374151',
                800: '#1f2937',
                900: '#111827',
              }
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'fade-in': 'fadeIn 0.3s ease-in-out',
              'slide-up': 'slideUp 0.4s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { transform: 'translateY(10px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              }
            }
          }
        }
      }
    </script>
    <style>
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 20px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      /* Markdown styles for better typography */
      .markdown h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        color: #111827;
      }
      .markdown h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 1.25rem;
        margin-bottom: 0.625rem;
        color: #1f2937;
      }
      .markdown h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        color: #374151;
      }
      .markdown p {
        margin-bottom: 0.75rem;
        line-height: 1.6;
      }
      .markdown ul, .markdown ol {
        margin-bottom: 0.75rem;
        padding-left: 1.5rem;
      }
      .markdown ul {
        list-style-type: disc;
      }
      .markdown ol {
        list-style-type: decimal;
      }
      .markdown li {
        margin-bottom: 0.375rem;
        line-height: 1.5;
      }
      .markdown strong, .markdown b {
        font-weight: 600;
        color: #111827;
      }
      .markdown em, .markdown i {
        font-style: italic;
      }
      .markdown blockquote {
        border-left: 3px solid #d1d5db;
        padding-left: 1rem;
        color: #4b5563;
        font-style: italic;
        margin: 0.75rem 0;
      }
      .markdown code {
        font-family: monospace;
        background-color: #f3f4f6;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
      }
      .markdown pre {
        background-color: #f3f4f6;
        padding: 0.75rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        margin-bottom: 0.75rem;
      }

      /* Typing indicator animation */
      .typing-indicator span {
        opacity: 0.5;
        animation: typing 1.5s infinite;
      }
      .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.3s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.6s;
      }
      @keyframes typing {
        0%, 100% {
          opacity: 0.2;
        }
        50% {
          opacity: 1;
        }
      }

      /* Highlight for key terms */
      .highlight {
        background: rgba(33, 151, 237, 0.1);
        border-bottom: 1px dotted rgba(33, 151, 237, 0.4);
        padding: 0 2px;
      }

      /* Hover effect for chat bubbles */
      .chat-bubble {
        transition: transform 0.2s ease;
      }
      .chat-bubble:hover {
        transform: translateY(-2px);
      }

      /* Slide transitions */
      .slide-transition {
        transition: all 0.3s ease-in-out;
      }

      /* Focus effect for active panel */
      .panel-focus {
        transition: all 0.3s ease;
      }
      .panel-focus:focus-within {
        box-shadow: 0 0 0 2px rgba(33, 151, 237, 0.2);
      }
    </style>
  </head>
  <body class="bg-white text-neutral-800 min-h-screen overflow-hidden">
    <div class="flex flex-col h-screen">
      <!-- Minimal Header -->
      <header class="py-4 px-6 border-b border-neutral-200 flex items-center justify-between bg-white">
        <div class="flex items-center space-x-3">
          <div class="w-9 h-9 flex items-center justify-center bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-lg shadow-sm">
            <i class="ri-file-search-line text-lg"></i>
          </div>
          <h1 class="text-xl font-semibold text-primary-700">DocSense</h1>
        </div>
        <div class="flex items-center space-x-2">
          <span id="statusIndicator" class="hidden items-center text-sm text-neutral-500">
            <span class="inline-block w-2 h-2 mr-2 bg-primary-400 rounded-full animate-pulse"></span>
            Processing document...
          </span>
        </div>
      </header>

      <!-- Main Content Area -->
      <main class="flex-1 flex overflow-hidden">
        <!-- Left Panel: Document Upload & Summary -->
        <div class="w-1/2 flex flex-col h-full border-r border-neutral-200 panel-focus">
          <!-- Upload Section -->
          <div class="p-6">
            <!-- Upload Zone (initial state) -->
            <div id="uploadArea" class="cursor-pointer border-2 border-dashed border-primary-200 bg-primary-50 rounded-xl p-8 text-center transition hover:bg-primary-100 hover:border-primary-300 relative overflow-hidden">
              <div class="relative z-10">
                <i class="ri-upload-cloud-line text-4xl text-primary-500 mb-3"></i>
                <h3 class="text-lg font-medium mb-2">Drop your document here</h3>
                <p class="text-neutral-600 mb-3 max-w-md mx-auto text-sm">Upload PDF, DOCX, or TXT files for AI-powered analysis</p>
                <button class="px-4 py-2 bg-white border border-primary-300 text-primary-700 rounded-lg text-sm font-medium shadow-sm hover:bg-primary-50 transition">
                  Select File
                </button>
              </div>
              <!-- Decorative element -->
              <div class="absolute -bottom-16 -right-16 w-32 h-32 bg-primary-100 rounded-full opacity-50"></div>
              <div class="absolute -top-8 -left-8 w-16 h-16 bg-primary-200 rounded-full opacity-30"></div>
            </div>

            <!-- File Info (after upload) -->
            <div id="fileInfo" class="hidden animate-fade-in">
              <div class="flex items-center justify-between p-4 bg-neutral-50 rounded-lg border border-neutral-200 mb-4">
                <div class="flex items-center space-x-3">
                  <div class="w-10 h-10 flex items-center justify-center bg-primary-100 text-primary-700 rounded">
                    <i class="ri-file-text-line text-xl"></i>
                  </div>
                  <div>
                    <div id="fileName" class="font-medium text-neutral-800">Document.pdf</div>
                    <div class="text-sm text-neutral-500 flex items-center">
                      <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5"></span>
                      Ready for analysis
                    </div>
                  </div>
                </div>
                <button id="changeButton" class="text-neutral-500 hover:text-primary-600 transition">
                  <i class="ri-refresh-line text-lg"></i>
                </button>
              </div>

              <!-- Generate Button -->
              <button id="generateSummaryBtn" class="w-full py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-sm transition flex items-center justify-center space-x-2">
                <i class="ri-magic-line"></i>
                <span>Generate Analysis</span>
              </button>
            </div>
          </div>

          <!-- Summary Container -->
          <div id="summaryContainer" class="flex-1 overflow-auto px-6 pb-6">
            <div id="summaryPlaceholder" class="h-full flex flex-col items-center justify-center text-center p-8">
              <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="Document" class="w-20 h-20 opacity-10 mb-4">
              <h4 class="text-lg font-medium text-neutral-400 mb-2">No Document Analyzed</h4>
              <p class="text-sm text-neutral-400 max-w-xs">Upload a document and generate an analysis to see AI-extracted insights here</p>
            </div>

            <div id="summaryContent" class="hidden animate-fade-in">
              <!-- Generation Progress Indicator -->
              <div id="generationProgress" class="hidden mb-6 bg-primary-50 rounded-lg p-4 border border-primary-100">
                <div class="flex justify-between items-center mb-2">
                  <div class="text-sm font-medium text-primary-800">Analyzing document</div>
                  <div id="progressPercent" class="text-xs font-medium text-primary-700">0%</div>
                </div>
                <div class="h-1.5 w-full bg-primary-100 rounded-full overflow-hidden">
                  <div id="progressBar" class="h-full bg-primary-500 rounded-full w-0 transition-all duration-300"></div>
                </div>
                <div id="progressStage" class="text-xs text-primary-600 mt-2">Extracting document content...</div>
              </div>

              <!-- Summary Title -->
              <div class="mb-4">
                <h2 class="text-lg font-semibold text-neutral-800">Document Analysis</h2>
                <p class="text-neutral-500 text-sm">AI-generated insights and key points</p>
              </div>

              <!-- Summary Text -->
              <div id="summaryText" class="markdown text-neutral-700">
                <!-- Content will be populated by JS -->
              </div>
            </div>
          </div>
        </div>

        <!-- Right Panel: Chat -->
        <div class="w-1/2 flex flex-col h-full panel-focus">
          <div class="p-6 border-b border-neutral-200">
            <h2 class="text-lg font-semibold text-neutral-800">Ask Questions About This Document</h2>
            <p class="text-neutral-500 text-sm">Get specific answers based on the document content</p>
          </div>

          <div id="chatMessages" class="flex-1 overflow-auto px-6 py-4 space-y-4">
            <!-- Chat Placeholder -->
            <div id="chatPlaceholder" class="h-full flex flex-col items-center justify-center text-center p-8">
              <img src="https://cdn-icons-png.flaticon.com/512/1041/1041916.png" alt="Chat" class="w-20 h-20 opacity-10 mb-4">
              <h4 class="text-lg font-medium text-neutral-400 mb-2">No Conversation Yet</h4>
              <p class="text-sm text-neutral-400 max-w-xs">After analyzing your document, you can ask questions about its content</p>
            </div>
            <!-- Messages will be added here by JS -->
          </div>

          <div class="p-4 border-t border-neutral-200 bg-neutral-50">
            <div class="relative">
              <textarea
                id="chatInput"
                class="w-full min-h-[48px] max-h-[120px] py-3 px-4 pr-12 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-primary-400 text-sm resize-none disabled:bg-neutral-50 disabled:text-neutral-400"
                placeholder="Ask a question about the document..."
                rows="1"
                disabled
              ></textarea>
              <button id="chatSendBtn" class="absolute right-2 bottom-2 w-9 h-9 flex items-center justify-center bg-primary-600 text-white rounded-full hover:bg-primary-700 disabled:bg-neutral-300 disabled:cursor-not-allowed transition" disabled>
                <i class="ri-send-plane-fill text-sm"></i>
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Global state variables
      let bridge = null;
      let isFileSelected = false;
      let isGeneratingSummary = false;
      let documentContent = ""; // Document content used for chat
      let chatHistory = []; // Array to store chat messages

      // Initialize when the document is ready
      window.onload = function () {
        if (
          typeof QWebChannel !== "undefined" &&
          typeof qt !== "undefined" &&
          qt.webChannelTransport
        ) {
          console.log("Initializing QWebChannel...");
          new QWebChannel(qt.webChannelTransport, function (channel) {
            bridge = channel.objects.bridge;
            console.log("Bridge connected successfully");
            setupEventListeners();
          });
        } else {
          console.log("QWebChannel not available, running in test mode");
          setupEventListeners();
        }
      };

      // Set up event listeners
      function setupEventListeners() {
        const uploadArea = document.getElementById("uploadArea");
        if (uploadArea) {
          uploadArea.addEventListener("click", requestFileUpload);
          uploadArea.addEventListener("dragover", function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add("bg-primary-100", "border-primary-300");
          });
          uploadArea.addEventListener("dragleave", function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove("bg-primary-100", "border-primary-300");
          });
          uploadArea.addEventListener("drop", function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove("bg-primary-100", "border-primary-300");
            requestFileUpload();
          });
        }

        const changeButton = document.getElementById("changeButton");
        if (changeButton) {
          changeButton.addEventListener("click", requestFileUpload);
        }

        const generateSummaryBtn = document.getElementById("generateSummaryBtn");
        if (generateSummaryBtn) {
          generateSummaryBtn.addEventListener("click", function () {
            if (isFileSelected && !isGeneratingSummary) {
              requestSummaryGeneration();
            }
          });
        }

        // Chat input handling
        const chatInput = document.getElementById("chatInput");
        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatInput) {
          chatInput.addEventListener("input", function () {
            if (chatSendBtn) {
              chatSendBtn.disabled = !this.value.trim();
            }
            // Auto-resize textarea
            this.style.height = "auto";
            this.style.height = Math.min(this.scrollHeight, 120) + "px";
          });
          chatInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              if (chatSendBtn && !chatSendBtn.disabled) {
                sendChatMessage();
              }
            }
          });
        }
        if (chatSendBtn) {
          chatSendBtn.addEventListener("click", sendChatMessage);
        }
      }

      // Request file selection (handled by Python bridge)
      function requestFileUpload() {
        if (bridge) {
          console.log("Requesting file selection...");
          bridge.requestDocumentSummary();
        } else {
          // Test mode
          setTimeout(() => {
            setFileName("SE Lectures Notes - Unit 1.pdf");
          }, 500);
        }
      }

      // Request summary generation via the bridge
      function requestSummaryGeneration() {
        showGenerationProgress();
        isGeneratingSummary = true;

        const statusIndicator = document.getElementById("statusIndicator");
        if (statusIndicator) {
          statusIndicator.classList.remove("hidden");
          statusIndicator.classList.add("flex");
        }

        if (bridge) {
          console.log("Requesting summary generation...");
          bridge.generateDocumentSummary();
        } else {
          // Test mode
          simulateProgress();
          setTimeout(() => {
            const sampleSummary = `# Comprehensive Summary of Software Engineering Lecture Notes

## Unit 1: Software Engineering and Processes
### Lecture 1: Introduction

* **Welcome and Introduction**: Arsalan Manzoor, Assistant Professor at the Department of Computer Science and Engineering (CSE), MIET Jammu, welcomed students and introduced himself. He also provided feedback about MIET.

* **Discussion on Science, Engineering, and Technology**:
  * **Science**: Focuses on understanding how things work in the world through observation and experimentation.
  * **Engineering**: Applies scientific principles to design and build systems, structures, devices, and processes to solve practical problems.
  * **Technology**: Refers to tools, techniques, and systems developed through engineering to fulfill various tasks, often resulting in innovations that improve efficiency and convenience.

### Lecture 2: Understanding Software

* **Definition of Program**: A computer program is a sequence or set of instructions in a programming language for a computer to execute.

* **Definition of Software**: Software is a set of instructions, data, or programs used to operate computers and execute specific tasks. It includes executable programming code, associated libraries, and documentation.

* **Characteristics of Software**: Intangible, variable, and customizable to meet specific needs.`;

            // Apply highlighting to key terms
            const processedSummary = sampleSummary.replace(
              /\*\*(.*?)\*\*/g,
              '<span class="highlight">$1</span>'
            );

            displayDocumentSummary(processedSummary);
            documentContent = sampleSummary; // Store content for chat
            hideGenerationProgress();
          }, 5000);
        }
      }

      // Called from Python after file selection
      function setFileName(name) {
        console.log("File selected:", name);
        const fileNameEl = document.getElementById("fileName");
        if (fileNameEl) {
          fileNameEl.textContent = name;
        }
        const fileInfo = document.getElementById("fileInfo");
        if (fileInfo) {
          fileInfo.classList.remove("hidden");
        }
        const uploadArea = document.getElementById("uploadArea");
        if (uploadArea) {
          uploadArea.classList.add("hidden");
        }

        isFileSelected = true;
        resetSummarySection();
        resetChatSection();
      }

      // Called from Python to update status messages
      function updateStatus(message, statusType) {
        console.log("Status update:", message, statusType);

        if (statusType === "loading") {
          updateProgressStage(message);
        } else if (statusType === "success") {
          updateProgressStage("Complete!");
          updateProgressBar(100);

          setTimeout(hideGenerationProgress, 800);

          const statusIndicator = document.getElementById("statusIndicator");
          if (statusIndicator) {
            statusIndicator.classList.add("hidden");
            statusIndicator.classList.remove("flex");
          }
        } else if (statusType === "error") {
          updateProgressStage("An error occurred: " + message);

          setTimeout(hideGenerationProgress, 1500);

          const statusIndicator = document.getElementById("statusIndicator");
          if (statusIndicator) {
            statusIndicator.classList.add("hidden");
            statusIndicator.classList.remove("flex");
          }
        }
      }

      // Called from Python when summary is generated
      function displayDocumentSummary(summary) {
        console.log("Summary received, length:", summary.length);
        try {
          const htmlSummary = marked.parse(summary);
          const summaryText = document.getElementById("summaryText");
          if (summaryText) {
            summaryText.innerHTML = htmlSummary;
          }

          const summaryPlaceholder = document.getElementById("summaryPlaceholder");
          if (summaryPlaceholder) {
            summaryPlaceholder.classList.add("hidden");
          }

          const summaryContent = document.getElementById("summaryContent");
          if (summaryContent) {
            summaryContent.classList.remove("hidden");
          }

          documentContent = summary;
          enableChatFeature();
        } catch (error) {
          console.error("Error parsing markdown:", error);
          const summaryText = document.getElementById("summaryText");
          if (summaryText) {
            summaryText.textContent = summary;
          }

          const summaryPlaceholder = document.getElementById("summaryPlaceholder");
          if (summaryPlaceholder) {
            summaryPlaceholder.classList.add("hidden");
          }

          const summaryContent = document.getElementById("summaryContent");
          if (summaryContent) {
            summaryContent.classList.remove("hidden");
          }

          documentContent = summary;
          enableChatFeature();
        }
        isGeneratingSummary = false;
      }

      function enableChatFeature() {
        // Clear chat placeholder
        const chatPlaceholder = document.getElementById("chatPlaceholder");
        if (chatPlaceholder) {
          chatPlaceholder.classList.add("hidden");
        }

        // Add initial assistant message
        addChatMessage("I've analyzed your document. Ask me anything about it, and I'll provide specific answers based on its content.", "assistant");

        // Enable chat input
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.disabled = false;
          chatInput.focus();
        }
      }

      function resetSummarySection() {
        const summaryText = document.getElementById("summaryText");
        if (summaryText) {
          summaryText.innerHTML = "";
        }

        const summaryPlaceholder = document.getElementById("summaryPlaceholder");
        if (summaryPlaceholder) {
          summaryPlaceholder.classList.remove("hidden");
        }

        const summaryContent = document.getElementById("summaryContent");
        if (summaryContent) {
          summaryContent.classList.add("hidden");
        }

        const generationProgress = document.getElementById("generationProgress");
        if (generationProgress) {
          generationProgress.classList.add("hidden");
        }
      }

      function resetChatSection() {
        const chatMessages = document.getElementById("chatMessages");
        if (chatMessages) {
          // Clear all messages
          while (chatMessages.firstChild) {
            chatMessages.removeChild(chatMessages.firstChild);
          }

          // Add placeholder back
          const chatPlaceholder = document.getElementById("chatPlaceholder");
          if (chatPlaceholder) {
            chatPlaceholder.classList.remove("hidden");
            chatMessages.appendChild(chatPlaceholder);
          }
        }

        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.value = "";
          chatInput.style.height = "auto";
          chatInput.disabled = true;
        }

        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatSendBtn) {
          chatSendBtn.disabled = true;
        }

        chatHistory = [];
      }

      // Progress handling
      function showGenerationProgress() {
        const generationProgress = document.getElementById("generationProgress");
        if (generationProgress) {
          generationProgress.classList.remove("hidden");
        }

        const summaryPlaceholder = document.getElementById("summaryPlaceholder");
        if (summaryPlaceholder) {
          summaryPlaceholder.classList.add("hidden");
        }

        const summaryContent = document.getElementById("summaryContent");
        if (summaryContent) {
          summaryContent.classList.remove("hidden");
        }

        updateProgressBar(0);
        updateProgressStage("Initializing document analysis...");

        const generateSummaryBtn = document.getElementById("generateSummaryBtn");
        if (generateSummaryBtn) {
          generateSummaryBtn.disabled = true;
        }

        simulateProgress();
      }

      function hideGenerationProgress() {
        const generationProgress = document.getElementById("generationProgress");
        if (generationProgress) {
          generationProgress.classList.add("hidden");
        }

        const generateSummaryBtn = document.getElementById("generateSummaryBtn");
        if (generateSummaryBtn) {
          generateSummaryBtn.disabled = false;
        }

        if (window.progressInterval) {
          clearInterval(window.progressInterval);
        }
      }

      function updateProgressBar(percent) {
        const progressBar = document.getElementById("progressBar");
        const progressPercent = document.getElementById("progressPercent");

        if (progressBar) {
          progressBar.style.width = percent + "%";
        }

        if (progressPercent) {
          progressPercent.textContent = Math.round(percent) + "%";
        }
      }

      function updateProgressStage(message) {
        const progressStage = document.getElementById("progressStage");
        if (progressStage) {
          progressStage.textContent = message;
        }
      }

      function simulateProgress() {
        const progressSteps = [
          {
            percent: 15,
            text: "Extracting document content..."
          },
          {
            percent: 30,
            text: "Analyzing document structure..."
          },
          {
            percent: 45,
            text: "Identifying key concepts and topics..."
          },
          {
            percent: 60,
            text: "Building knowledge graph from content..."
          },
          {
            percent: 75,
            text: "Generating comprehensive summary..."
          },
          {
            percent: 90,
            text: "Finalizing analysis and formatting..."
          },
        ];

        let currentStep = 0;
        if (window.progressInterval) {
          clearInterval(window.progressInterval);
        }

        window.progressInterval = setInterval(function () {
          if (currentStep < progressSteps.length) {
            const step = progressSteps[currentStep];
            updateProgressBar(step.percent);
            updateProgressStage(step.text);
            currentStep++;
          } else {
            let width = parseFloat(document.getElementById("progressBar").style.width) || 90;
            if (width < 95) {
              width += 0.2;
              updateProgressBar(width);
            }
          }
        }, 800);
      }

      // Chat functionality
      function addChatMessage(content, role) {
        const chatMessages = document.getElementById("chatMessages");
        if (!chatMessages) return;

        const chatPlaceholder = document.getElementById("chatPlaceholder");
        if (chatPlaceholder && !chatPlaceholder.classList.contains("hidden")) {
          chatPlaceholder.classList.add("hidden");
        }

        const messageDiv = document.createElement("div");
        messageDiv.classList.add("animate-slide-up", "max-w-[90%]");

        if (role === "user") {
          messageDiv.classList.add("ml-auto");

          const innerDiv = document.createElement("div");
          innerDiv.classList.add("chat-bubble", "bg-primary-600", "text-white", "rounded-2xl", "rounded-tr-sm", "px-4", "py-3", "inline-block", "shadow-sm");
          innerDiv.textContent = content;

          messageDiv.appendChild(innerDiv);
        } else if (role === "assistant") {
          messageDiv.classList.add("mr-auto");

          const innerDiv = document.createElement("div");
          innerDiv.classList.add("chat-bubble", "bg-neutral-100", "rounded-2xl", "rounded-tl-sm", "px-4", "py-3", "markdown", "text-neutral-800", "shadow-sm");

          // Replace markdown links with highlighted spans
          let processedContent = content.replace(/\*\*(.*?)\*\*/g, '<span class="highlight">$1</span>');
          innerDiv.innerHTML = marked.parse(processedContent);

          messageDiv.appendChild(innerDiv);
        } else if (role === "thinking") {
          messageDiv.classList.add("mr-auto");

          const innerDiv = document.createElement("div");
          innerDiv.classList.add("bg-neutral-100", "rounded-2xl", "rounded-tl-sm", "px-4", "py-3", "text-neutral-600", "shadow-sm");

          const typingIndicator = document.createElement("div");
          typingIndicator.classList.add("typing-indicator", "flex", "items-center", "space-x-1");

          const textSpan = document.createElement("span");
          textSpan.textContent = "Thinking";

          const dot1 = document.createElement("span");
          dot1.textContent = "•";
          const dot2 = document.createElement("span");
          dot2.textContent = "•";
          const dot3 = document.createElement("span");
          dot3.textContent = "•";

          typingIndicator.appendChild(textSpan);
          typingIndicator.appendChild(dot1);
          typingIndicator.appendChild(dot2);
          typingIndicator.appendChild(dot3);

          innerDiv.appendChild(typingIndicator);
          messageDiv.appendChild(innerDiv);
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (role !== "thinking") {
          chatHistory.push({ role: role, content: content });
        }

        return messageDiv;
      }

      function sendChatMessage() {
        const chatInput = document.getElementById("chatInput");
        if (!chatInput) return;

        const question = chatInput.value.trim();
        if (!question) return;

        addChatMessage(question, "user");
        chatInput.value = "";
        chatInput.style.height = "auto";

        // Disable input while waiting for response
        chatInput.disabled = true;

        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatSendBtn) {
          chatSendBtn.disabled = true;
        }

        const thinkingMessage = addChatMessage("", "thinking");

        if (bridge) {
          bridge.askDocumentQuestion(question);
        } else {
          // Test mode - simulate response
          setTimeout(() => {
            // Remove thinking message
            if (thinkingMessage) {
              thinkingMessage.remove();
            }

            // Sample responses based on questions with Markdown formatting
            let sampleAnswer = "";
            if (question.toLowerCase().includes("agile")) {
              sampleAnswer = "# Agile Development\n\nAgile is a software development approach based on iterative development. It involves breaking tasks into smaller parts and working through a full software development lifecycle in each iteration.\n\n## Key Characteristics\n\n* **Iterative Process**: The project scope and requirements are defined at the beginning of the development process\n* **Well-Defined Iterations**: Plans regarding the number of iterations, duration, and scope of each iteration are clearly defined in advance\n* **Flexible but Structured**: Allows for adaptation while maintaining project management control";
            } else if (question.toLowerCase().includes("engineering")) {
              sampleAnswer = "According to the document, **Engineering** applies scientific principles to design and build systems, structures, devices, and processes to solve practical problems.\n\nIt's one of the three key concepts discussed alongside Science and Technology. Engineering serves as the bridge between scientific knowledge and technological implementation.";
            } else if (question.toLowerCase().includes("software")) {
              sampleAnswer = "## Definition of Software\n\nThe document defines software as a set of instructions, data, or programs used to operate computers and execute specific tasks. It includes:\n\n* Executable programming code\n* Associated libraries\n* Documentation\n\n### Characteristics of Software\n\n* Intangible\n* Variable\n* Customizable to meet specific needs";
            } else {
              sampleAnswer = "Based on the lecture notes, software engineering fundamentals include:\n\n1. Understanding the differences between programs and software\n2. Recognizing the characteristics of software\n3. Applying engineering principles to software development processes\n\nThe document also discusses the relationships between science, engineering, and technology as foundational concepts:\n\n* **Science**: Focus on understanding\n* **Engineering**: Application of principles\n* **Technology**: Implementation of tools and systems";
            }

            addChatMessage(sampleAnswer, "assistant");

            // Re-enable input
            chatInput.disabled = false;
            chatInput.focus();

            if (chatSendBtn) {
              chatSendBtn.disabled = false;
            }
          }, 2000);
        }
      }

      // Called from Python when chat response is received
      function displayChatResponse(response, error) {
        // Remove any thinking messages
        const thinkingMessages = document.querySelectorAll(".typing-indicator");
        thinkingMessages.forEach((msg) => {
          const parentMessage = msg.closest(".animate-slide-up");
          if (parentMessage) {
            parentMessage.remove();
          }
        });

        if (error) {
          addChatMessage("Sorry, I encountered an error: " + error, "assistant");
        } else {
          addChatMessage(response, "assistant");
        }

        // Enable chat input
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.disabled = false;
          chatInput.focus();
        }

        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatSendBtn) {
          chatSendBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
