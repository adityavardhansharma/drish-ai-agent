<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocSense - Smart Document Analysis</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
    <style>
      :root {
        /* Color system */
        --primary-50: #eef2ff;
        --primary-100: #e0e7ff;
        --primary-200: #c7d2fe;
        --primary-300: #a5b4fc;
        --primary-400: #818cf8;
        --primary-500: #6366f1;
        --primary-600: #4f46e5;
        --primary-700: #4338ca;
        --primary-800: #3730a3;
        --primary-900: #312e81;

        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;

        --success-50: #ecfdf5;
        --success-500: #10b981;
        --success-600: #059669;

        --warning-50: #fffbeb;
        --warning-500: #f59e0b;
        --warning-600: #d97706;

        --error-50: #fef2f2;
        --error-500: #ef4444;
        --error-600: #dc2626;

        /* Spacing system */
        --space-2: 0.125rem;
        --space-4: 0.25rem;
        --space-8: 0.5rem;
        --space-12: 0.75rem;
        --space-16: 1rem;
        --space-20: 1.25rem;
        --space-24: 1.5rem;
        --space-32: 2rem;
        --space-40: 2.5rem;
        --space-48: 3rem;
        --space-64: 4rem;

        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

        /* Border radius */
        --radius-sm: 0.125rem;
        --radius: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --radius-2xl: 1.5rem;
        --radius-full: 9999px;

        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: var(--gray-100);
        color: var(--gray-900);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      h1, h2, h3, h4, h5, h6 {
        font-family: 'Plus Jakarta Sans', sans-serif;
        font-weight: 600;
        line-height: 1.25;
      }

      /* Layout */
      .app-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        max-width: 1280px;
        margin: 0 auto;
        padding: var(--space-16);
      }

      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-32);
      }

      .app-logo {
        display: flex;
        align-items: center;
        gap: var(--space-12);
        font-family: 'Plus Jakarta Sans', sans-serif;
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--primary-600);
      }

      .app-logo-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
        color: white;
        border-radius: var(--radius-lg);
        font-size: 1.25rem;
      }

      .app-main {
        display: flex;
        flex-direction: column;
        gap: var(--space-32);
        flex: 1;
      }

      .card {
        background-color: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        transition: var(--transition);
      }

      .card-header {
        padding: var(--space-20) var(--space-24);
        border-bottom: 1px solid var(--gray-100);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .card-title {
        display: flex;
        align-items: center;
        gap: var(--space-12);
        font-weight: 600;
        font-size: 1.125rem;
        color: var(--gray-900);
      }

      .card-title-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background-color: var(--primary-50);
        color: var(--primary-600);
        border-radius: var(--radius);
        font-size: 1.125rem;
      }

      .card-body {
        padding: var(--space-24);
      }

      /* Upload area */
      .upload-zone {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-48) var(--space-24);
        border: 2px dashed var(--primary-200);
        border-radius: var(--radius-lg);
        background-color: var(--primary-50);
        transition: var(--transition);
        cursor: pointer;
        text-align: center;
      }

      .upload-zone:hover {
        border-color: var(--primary-400);
        background-color: var(--primary-100);
      }

      .upload-icon {
        width: 64px;
        height: 64px;
        color: var(--primary-500);
        margin-bottom: var(--space-20);
      }

      .upload-title {
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: var(--space-8);
        color: var(--gray-900);
      }

      .upload-subtitle {
        color: var(--gray-600);
        margin-bottom: var(--space-16);
        max-width: 400px;
      }

      .format-tags {
        display: flex;
        gap: var(--space-8);
        margin-top: var(--space-16);
      }

      .format-tag {
        padding: var(--space-4) var(--space-12);
        background-color: white;
        border-radius: var(--radius-full);
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-700);
        box-shadow: var(--shadow-sm);
      }

      /* File info */
      .file-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-16) var(--space-20);
        background-color: var(--gray-50);
        border-radius: var(--radius-lg);
        border: 1px solid var(--gray-200);
      }

      .file-details {
        display: flex;
        align-items: center;
        gap: var(--space-16);
      }

      .file-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        background-color: var(--primary-50);
        color: var(--primary-600);
        border-radius: var(--radius);
        font-size: 1.5rem;
      }

      .file-name {
        font-weight: 600;
        font-size: 1rem;
        color: var(--gray-900);
        margin-bottom: var(--space-4);
      }

      .file-status {
        font-size: 0.875rem;
        color: var(--gray-600);
        display: flex;
        align-items: center;
        gap: var(--space-8);
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        background-color: var(--success-500);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-8);
        padding: var(--space-12) var(--space-20);
        border-radius: var(--radius-md);
        font-weight: 500;
        font-size: 0.875rem;
        transition: var(--transition);
        cursor: pointer;
        border: none;
        outline: none;
      }

      .btn-primary {
        background-color: var(--primary-600);
        color: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .btn-primary:hover {
        background-color: var(--primary-700);
      }

      .btn-primary:focus {
        box-shadow: 0 0 0 3px var(--primary-200);
      }

      .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .btn-outline {
        background-color: transparent;
        color: var(--primary-600);
        border: 1px solid var(--primary-200);
      }

      .btn-outline:hover {
        background-color: var(--primary-50);
        border-color: var(--primary-300);
      }

      .btn-icon {
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: var(--radius);
      }

      .btn-lg {
        padding: var(--space-12) var(--space-24);
        font-size: 1rem;
      }

      /* Analysis section */
      .analysis-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-24);
      }

      @media (max-width: 768px) {
        .analysis-container {
          grid-template-columns: 1fr;
        }
      }

      .summary-container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .summary-content {
        flex: 1;
        padding: var(--space-24);
        overflow-y: auto;
        max-height: 600px;
      }

      .summary-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 300px;
        text-align: center;
        color: var(--gray-500);
      }

      .placeholder-icon {
        font-size: 3rem;
        margin-bottom: var(--space-16);
        opacity: 0.3;
      }

      .placeholder-title {
        font-weight: 600;
        font-size: 1.125rem;
        margin-bottom: var(--space-8);
        color: var(--gray-700);
      }

      .placeholder-text {
        max-width: 300px;
        font-size: 0.875rem;
        color: var(--gray-500);
      }

      .summary-text {
        color: var(--gray-800);
        line-height: 1.6;
      }

      .summary-text h1 {
        font-size: 1.5rem;
        margin-bottom: var(--space-16);
        color: var(--gray-900);
      }

      .summary-text h2 {
        font-size: 1.25rem;
        margin-top: var(--space-24);
        margin-bottom: var(--space-12);
        color: var(--gray-900);
      }

      .summary-text h3 {
        font-size: 1.125rem;
        margin-top: var(--space-20);
        margin-bottom: var(--space-8);
        color: var(--gray-900);
      }

      .summary-text p {
        margin-bottom: var(--space-16);
      }

      .summary-text ul, .summary-text ol {
        margin-bottom: var(--space-16);
        padding-left: var(--space-24);
      }

      .summary-text li {
        margin-bottom: var(--space-8);
      }

      .summary-text blockquote {
        border-left: 3px solid var(--primary-300);
        padding-left: var(--space-16);
        margin: var(--space-16) 0;
        color: var(--gray-700);
        font-style: italic;
      }

      /* Chat section */
      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .chat-messages {
        flex: 1;
        padding: var(--space-24);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: var(--space-16);
        max-height: 500px;
      }

      .chat-input-container {
        padding: var(--space-16) var(--space-24);
        border-top: 1px solid var(--gray-100);
        display: flex;
        gap: var(--space-12);
      }

      .chat-input {
        flex: 1;
        padding: var(--space-12) var(--space-16);
        border-radius: var(--radius-lg);
        border: 1px solid var(--gray-300);
        font-family: inherit;
        font-size: 0.875rem;
        resize: none;
        min-height: 48px;
        max-height: 120px;
        overflow-y: auto;
        transition: var(--transition);
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-100);
      }

      .message {
        max-width: 85%;
        padding: var(--space-16);
        border-radius: var(--radius-lg);
        line-height: 1.5;
        font-size: 0.9375rem;
      }

      .message-user {
        align-self: flex-end;
        background-color: var(--primary-500);
        color: white;
        border-bottom-right-radius: var(--space-4);
      }

      .message-assistant {
        align-self: flex-start;
        background-color: var(--gray-100);
        color: var(--gray-800);
        border-bottom-left-radius: var(--space-4);
      }

      .message-thinking {
        align-self: flex-start;
        background-color: var(--gray-100);
        color: var(--gray-500);
        border-bottom-left-radius: var(--space-4);
        font-style: italic;
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
      }

      .loading-card {
        background-color: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        padding: var(--space-32);
        width: 400px;
        text-align: center;
      }

      .loading-animation {
        margin: 0 auto var(--space-24);
        position: relative;
        width: 80px;
        height: 80px;
      }

      .loading-animation div {
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: var(--radius-full);
        background-color: var(--primary-500);
        animation: loading 1.2s linear infinite;
      }

      .loading-animation div:nth-child(1) {
        top: 8px;
        left: 8px;
        animation-delay: 0s;
      }

      .loading-animation div:nth-child(2) {
        top: 8px;
        left: 32px;
        animation-delay: -0.4s;
      }

      .loading-animation div:nth-child(3) {
        top: 8px;
        left: 56px;
        animation-delay: -0.8s;
      }

      .loading-animation div:nth-child(4) {
        top: 32px;
        left: 8px;
        animation-delay: -0.4s;
      }

      .loading-animation div:nth-child(5) {
        top: 32px;
        left: 32px;
        animation-delay: -0.8s;
      }

      .loading-animation div:nth-child(6) {
        top: 32px;
        left: 56px;
        animation-delay: -1.2s;
      }

      .loading-animation div:nth-child(7) {
        top: 56px;
        left: 8px;
        animation-delay: -0.8s;
      }

      .loading-animation div:nth-child(8) {
        top: 56px;
        left: 32px;
        animation-delay: -1.2s;
      }

      .loading-animation div:nth-child(9) {
        top: 56px;
        left: 56px;
        animation-delay: -1.6s;
      }

      @keyframes loading {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .loading-title {
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: var(--space-12);
        color: var(--gray-900);
      }

      .loading-text {
        color: var(--gray-600);
        margin-bottom: var(--space-20);
      }

      .progress-bar {
        height: 6px;
        background-color: var(--gray-100);
        border-radius: var(--radius-full);
        overflow: hidden;
        margin-bottom: var(--space-8);
      }

      .progress-fill {
        height: 100%;
        background-color: var(--primary-500);
        width: 0%;
        transition: width 0.3s ease;
      }

      .progress-text {
        font-size: 0.875rem;
        color: var(--gray-500);
        text-align: left;
      }

      /* Utility classes */
      .hidden {
        display: none !important;
      }

      .text-center {
        text-align: center;
      }

      .mt-24 {
        margin-top: var(--space-24);
      }

      .mt-16 {
        margin-top: var(--space-16);
      }

      .mb-16 {
        margin-bottom: var(--space-16);
      }

      .mb-8 {
        margin-bottom: var(--space-8);
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }

      /* Tooltip */
      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: var(--gray-800);
        color: white;
        text-align: center;
        border-radius: var(--radius);
        padding: var(--space-8) var(--space-12);
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.75rem;
        font-weight: 400;
        box-shadow: var(--shadow-md);
      }

      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- App Header -->
      <header class="app-header">
        <div class="app-logo">
          <div class="app-logo-icon">
            <i class="ri-file-search-line"></i>
          </div>
          DocSense
        </div>
      </header>

      <!-- Main Content -->
      <main class="app-main">
        <!-- Upload Section -->
        <section class="card fade-in">
          <div class="card-header">
            <div class="card-title">
              <div class="card-title-icon">
                <i class="ri-upload-cloud-line"></i>
              </div>
              Document Upload
            </div>
          </div>
          <div class="card-body">
            <!-- Upload Zone (Initial State) -->
            <div id="uploadArea" class="upload-zone">
              <i class="ri-upload-cloud-line upload-icon"></i>
              <h3 class="upload-title">Drag & Drop or Click to Upload</h3>
              <p class="upload-subtitle">Upload your document to extract insights and generate a comprehensive summary</p>
              <div class="format-tags">
                <span class="format-tag">PDF</span>
                <span class="format-tag">DOCX</span>
                <span class="format-tag">TXT</span>
                <span class="format-tag">RTF</span>
              </div>
            </div>

            <!-- File Info (After Upload) -->
            <div id="fileInfo" class="file-info hidden">
              <div class="file-details">
                <div class="file-icon">
                  <i class="ri-file-text-line"></i>
                </div>
                <div>
                  <div id="fileName" class="file-name">Document.pdf</div>
                  <div class="file-status">
                    <span class="status-indicator"></span>
                    Ready for analysis
                  </div>
                </div>
              </div>
              <button id="changeButton" class="btn btn-outline">
                <i class="ri-refresh-line"></i>
                Change
              </button>
            </div>

            <!-- Generate Button -->
            <div id="generateBtnContainer" class="text-center mt-24 hidden">
              <button id="generateSummaryBtn" class="btn btn-primary btn-lg">
                <i class="ri-magic-line"></i>
                Generate Smart Summary
              </button>
            </div>
          </div>
        </section>

        <!-- Analysis Section -->
        <section id="analysisSection" class="card fade-in hidden">
          <div class="card-header">
            <div class="card-title">
              <div class="card-title-icon">
                <i class="ri-file-search-line"></i>
              </div>
              Document Analysis
            </div>
          </div>
          <div class="card-body">
            <div class="analysis-container">
              <!-- Summary Container -->
              <div class="summary-container card">
                <div class="card-header">
                  <div class="card-title">
                    <i class="ri-lightbulb-line"></i>
                    AI-Generated Summary
                  </div>
                  <div class="tooltip">
                    <i class="ri-information-line"></i>
                    <span class="tooltip-text">Our AI extracts key information and creates a concise summary of your document</span>
                  </div>
                </div>
                <div class="summary-content">
                  <!-- Summary Placeholder -->
                  <div id="summaryPlaceholder" class="summary-placeholder">
                    <i class="ri-file-list-3-line placeholder-icon"></i>
                    <h4 class="placeholder-title">No Summary Available</h4>
                    <p class="placeholder-text">Generate a summary to see the AI-extracted insights from your document</p>
                  </div>
                  <!-- Summary Text -->
                  <div id="summaryText" class="summary-text hidden">
                    <!-- Content will be populated by JS -->
                  </div>
                </div>
              </div>

              <!-- Chat Container -->
              <div id="chatContainer" class="chat-container card">
                <div class="card-header">
                  <div class="card-title">
                    <i class="ri-question-answer-line"></i>
                    Ask Questions About Document
                  </div>
                  <div class="tooltip">
                    <i class="ri-information-line"></i>
                    <span class="tooltip-text">Ask specific questions about the document content to get detailed answers</span>
                  </div>
                </div>
                <div id="chatMessages" class="chat-messages">
                  <!-- Chat Placeholder -->
                  <div id="chatPlaceholder" class="summary-placeholder">
                    <i class="ri-chat-3-line placeholder-icon"></i>
                    <h4 class="placeholder-title">Ask Questions About Your Document</h4>
                    <p class="placeholder-text">Type your questions below to get AI-powered answers based on your document</p>
                  </div>
                  <!-- Messages will be added here -->
                </div>
                <div class="chat-input-container">
                  <textarea
                    id="chatInput"
                    class="chat-input"
                    placeholder="Ask a question about the document..."
                    rows="1"
                  ></textarea>
                  <button id="chatSendBtn" class="btn btn-primary btn-icon" disabled>
                    <i class="ri-send-plane-fill"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="loading-card">
        <div class="loading-animation">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>
        <h3 id="loadingTitle" class="loading-title">Processing Document</h3>
        <p id="loadingText" class="loading-text">Analyzing content and extracting key information...</p>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <p id="progressText" class="progress-text">Extracting document content...</p>
      </div>
    </div>

    <script>
      // Global state variables
      let bridge = null;
      let isFileSelected = false;
      let isGeneratingSummary = false;
      let documentContent = ""; // Document content used for chat
      let chatHistory = []; // Array to store chat messages

      // Initialize when the document is ready
      window.onload = function () {
        if (
          typeof QWebChannel !== "undefined" &&
          typeof qt !== "undefined" &&
          qt.webChannelTransport
        ) {
          console.log("Initializing QWebChannel...");
          new QWebChannel(qt.webChannelTransport, function (channel) {
            bridge = channel.objects.bridge;
            console.log("Bridge connected successfully");
            setupEventListeners();
          });
        } else {
          console.log("QWebChannel not available, running in test mode");
          setupEventListeners();
        }
      };

      // Set up event listeners
      function setupEventListeners() {
        const uploadArea = document.getElementById("uploadArea");
        if (uploadArea) {
          uploadArea.addEventListener("click", requestFileUpload);
          uploadArea.addEventListener("dragover", function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.backgroundColor = "var(--primary-100)";
            this.style.borderColor = "var(--primary-400)";
          });
          uploadArea.addEventListener("dragleave", function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.backgroundColor = "";
            this.style.borderColor = "";
          });
          uploadArea.addEventListener("drop", function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.backgroundColor = "";
            this.style.borderColor = "";
            requestFileUpload();
          });
        }

                const changeButton = document.getElementById("changeButton");
        if (changeButton) {
          changeButton.addEventListener("click", requestFileUpload);
        }

        const generateSummaryBtn = document.getElementById("generateSummaryBtn");
        if (generateSummaryBtn) {
          generateSummaryBtn.addEventListener("click", function () {
            if (isFileSelected && !isGeneratingSummary) {
              requestSummaryGeneration();
            }
          });
        }

        // Chat input handling
        const chatInput = document.getElementById("chatInput");
        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatInput) {
          chatInput.addEventListener("input", function () {
            if (chatSendBtn) {
              chatSendBtn.disabled = !this.value.trim();
            }
            // Auto-resize textarea
            this.style.height = "auto";
            this.style.height = Math.min(this.scrollHeight, 120) + "px";
          });
          chatInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              if (chatSendBtn && !chatSendBtn.disabled) {
                sendChatMessage();
              }
            }
          });
        }
        if (chatSendBtn) {
          chatSendBtn.addEventListener("click", sendChatMessage);
        }
      }

      // Request file selection (handled by Python bridge)
      function requestFileUpload() {
        if (bridge) {
          console.log("Requesting file selection...");
          bridge.requestDocumentSummary();
        } else {
          // Test mode
          setTimeout(() => {
            setFileName("SE Lectures Notes - Unit 1.pdf");
          }, 500);
        }
      }

      // Request summary generation via the bridge
      function requestSummaryGeneration() {
        showLoadingOverlay();
        isGeneratingSummary = true;
        if (bridge) {
          console.log("Requesting summary generation...");
          bridge.generateDocumentSummary();
        } else {
          // Test mode
          simulateProgress();
          setTimeout(() => {
            const sampleSummary = `# Comprehensive Summary of Software Engineering Lecture Notes

## Unit 1: Software Engineering and Processes
### Lecture 1: Introduction

* **Welcome and Introduction**: Arsalan Manzoor, Assistant Professor at the Department of Computer Science and Engineering (CSE), MIET Jammu, welcomed students and introduced himself. He also provided feedback about MIET.

* **Discussion on Science, Engineering, and Technology**:
  * **Science**: Focuses on understanding how things work in the world through observation and experimentation.
  * **Engineering**: Applies scientific principles to design and build systems, structures, devices, and processes to solve practical problems.
  * **Technology**: Refers to tools, techniques, and systems developed through engineering to fulfill various tasks, often resulting in innovations that improve efficiency and convenience.

### Lecture 2: Understanding Software

* **Definition of Program**: A computer program is a sequence or set of instructions in a programming language for a computer to execute.

* **Definition of Software**: Software is a set of instructions, data, or programs used to operate computers and execute specific tasks. It includes executable programming code, associated libraries, and documentation.

* **Characteristics of Software**: Intangible, variable, and customizable to meet specific needs.`;
            displayDocumentSummary(sampleSummary);
            documentContent = sampleSummary; // Store content for chat
            showAnalysisSection();
          }, 3000);
        }
      }

      // Show analysis section after summary is generated
      function showAnalysisSection() {
        const analysisSection = document.getElementById("analysisSection");
        if (analysisSection) {
          analysisSection.classList.remove("hidden");
          // Smooth scroll to analysis section
          analysisSection.scrollIntoView({ behavior: "smooth" });
        }

        const chatContainer = document.getElementById("chatContainer");
        if (chatContainer) {
          chatContainer.classList.remove("hidden");
          const chatInput = document.getElementById("chatInput");
          if (chatInput) {
            setTimeout(() => {
              chatInput.focus();
            }, 500);
          }
        }
      }

      // Called from Python after file selection
      function setFileName(name) {
        console.log("File selected:", name);
        const fileNameEl = document.getElementById("fileName");
        if (fileNameEl) {
          fileNameEl.textContent = name;
        }
        const fileInfo = document.getElementById("fileInfo");
        if (fileInfo) {
          fileInfo.classList.remove("hidden");
        }
        const uploadArea = document.getElementById("uploadArea");
        if (uploadArea) {
          uploadArea.classList.add("hidden");
        }
        const generateBtnContainer = document.getElementById("generateBtnContainer");
        if (generateBtnContainer) {
          generateBtnContainer.classList.remove("hidden");
        }
        isFileSelected = true;
        resetSummarySection();

        // Hide analysis section when new file is selected
        const analysisSection = document.getElementById("analysisSection");
        if (analysisSection) {
          analysisSection.classList.add("hidden");
        }

        resetChatSection();
      }

      // Called from Python to update status messages
      function updateStatus(message, statusType) {
        console.log("Status update:", message, statusType);
        const loadingTitle = document.getElementById("loadingTitle");
        const loadingText = document.getElementById("loadingText");

        if (loadingText && statusType === "loading") {
          loadingText.textContent = message;
        } else if (statusType === "success") {
          if (loadingTitle) loadingTitle.textContent = "Success!";
          const progressFill = document.getElementById("progressFill");
          const progressText = document.getElementById("progressText");
          if (progressFill && progressText) {
            progressFill.style.width = "100%";
            loadingText.textContent = message;
            progressText.textContent = "Complete!";
          }
          setTimeout(hideLoadingOverlay, 800);
        } else if (statusType === "error") {
          if (loadingTitle) loadingTitle.textContent = "Error";
          if (loadingText) {
            loadingText.textContent = message;
          }
          const progressText = document.getElementById("progressText");
          if (progressText) {
            progressText.textContent = "An error occurred";
          }
          setTimeout(hideLoadingOverlay, 1500);
        }
      }

      // Called from Python when summary is generated
      function displayDocumentSummary(summary) {
        console.log("Summary received, length:", summary.length);
        try {
          const htmlSummary = marked.parse(summary);
          const summaryText = document.getElementById("summaryText");
          const summaryPlaceholder = document.getElementById("summaryPlaceholder");
          if (summaryText) {
            summaryText.innerHTML = htmlSummary;
            summaryPlaceholder.classList.add("hidden");
            summaryText.classList.remove("hidden");
          }
          documentContent = summary;
          showAnalysisSection();
        } catch (error) {
          console.error("Error parsing markdown:", error);
          const summaryText = document.getElementById("summaryText");
          const summaryPlaceholder = document.getElementById("summaryPlaceholder");
          if (summaryText) {
            summaryText.textContent = summary;
            summaryPlaceholder.classList.add("hidden");
            summaryText.classList.remove("hidden");
          }
          documentContent = summary;
          showAnalysisSection();
        }
        isGeneratingSummary = false;
      }

      // Called from Python when chat response is received
      function displayChatResponse(response, error) {
        // Remove any thinking message(s)
        const thinkingMessages = document.querySelectorAll(".message-thinking");
        thinkingMessages.forEach((msg) => msg.remove());
        if (error) {
          addChatMessage("Sorry, I encountered an error: " + error, "assistant");
        } else {
          addChatMessage(response, "assistant");
        }

        // Enable chat input
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.disabled = false;
          chatInput.focus();
        }
      }

      function resetSummarySection() {
        const summaryText = document.getElementById("summaryText");
        const summaryPlaceholder = document.getElementById("summaryPlaceholder");
        if (summaryText && summaryPlaceholder) {
          summaryText.classList.add("hidden");
          summaryPlaceholder.classList.remove("hidden");
        }
      }

      function resetChatSection() {
        const chatMessages = document.getElementById("chatMessages");
        const chatPlaceholder = document.getElementById("chatPlaceholder");
        if (chatMessages) {
          // Clear all messages except the placeholder
          while (chatMessages.firstChild && chatMessages.firstChild !== chatPlaceholder) {
            chatMessages.removeChild(chatMessages.firstChild);
          }
        }
        if (chatPlaceholder) {
          chatPlaceholder.classList.remove("hidden");
        }
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.value = "";
          chatInput.style.height = "auto";
        }
        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatSendBtn) {
          chatSendBtn.disabled = true;
        }
        chatHistory = [];
      }

      function showLoadingOverlay() {
        const loadingOverlay = document.getElementById("loadingOverlay");
        if (loadingOverlay) {
          loadingOverlay.classList.remove("hidden");
        }
        const progressFill = document.getElementById("progressFill");
        if (progressFill) {
          progressFill.style.width = "0%";
        }
        const loadingTitle = document.getElementById("loadingTitle");
        if (loadingTitle) {
          loadingTitle.textContent = "Processing Document";
        }
        const loadingText = document.getElementById("loadingText");
        if (loadingText) {
          loadingText.textContent = "Analyzing content and extracting key information...";
        }
        const progressText = document.getElementById("progressText");
        if (progressText) {
          progressText.textContent = "Extracting document content...";
        }
        const generateSummaryBtn = document.getElementById("generateSummaryBtn");
        if (generateSummaryBtn) {
          generateSummaryBtn.disabled = true;
        }
        simulateProgress();
      }

      function hideLoadingOverlay() {
        const loadingOverlay = document.getElementById("loadingOverlay");
        if (loadingOverlay) {
          loadingOverlay.classList.add("hidden");
        }
        const generateSummaryBtn = document.getElementById("generateSummaryBtn");
        if (generateSummaryBtn) {
          generateSummaryBtn.disabled = false;
        }
      }

      function simulateProgress() {
        const progressSteps = [
          {
            percent: 15,
            text: "Extracting document content...",
            loading: "Processing document structure..."
          },
          {
            percent: 30,
            text: "Analyzing text structure...",
            loading: "Identifying document sections..."
          },
          {
            percent: 45,
            text: "Identifying key concepts...",
            loading: "Extracting important information..."
          },
          {
            percent: 60,
            text: "Analyzing relationships between concepts...",
            loading: "Building knowledge graph..."
          },
          {
            percent: 75,
            text: "Generating comprehensive summary...",
            loading: "Creating concise summary..."
          },
          {
            percent: 90,
            text: "Finalizing and formatting results...",
            loading: "Preparing final output..."
          },
        ];

        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        const loadingText = document.getElementById("loadingText");

        let currentStep = 0;
        if (window.progressInterval) {
          clearInterval(window.progressInterval);
        }

        window.progressInterval = setInterval(function () {
          if (currentStep < progressSteps.length) {
            const step = progressSteps[currentStep];
            if (progressFill) {
              progressFill.style.width = step.percent + "%";
            }
            if (progressText) {
              progressText.textContent = step.text;
            }
            if (loadingText) {
              loadingText.textContent = step.loading;
            }
            currentStep++;
          } else {
            let width = parseFloat(progressFill.style.width) || 90;
            if (width < 95) {
              width += 0.2;
              progressFill.style.width = width + "%";
            }
          }
        }, 800);
      }

      // Chat functionality

      // Add message to chat
      function addChatMessage(content, role) {
        const chatMessages = document.getElementById("chatMessages");
        const chatPlaceholder = document.getElementById("chatPlaceholder");

        if (chatPlaceholder && !chatPlaceholder.classList.contains("hidden")) {
          chatPlaceholder.classList.add("hidden");
        }

        if (chatMessages) {
          const messageDiv = document.createElement("div");
          messageDiv.className = "message message-" + role;
          messageDiv.textContent = content;

          // Add animation class
          messageDiv.classList.add("fade-in");

          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          chatHistory.push({ role: role, content: content });
        }
      }

      // Add thinking message and return its ID
      function addThinkingMessage() {
        const chatMessages = document.getElementById("chatMessages");
        const chatPlaceholder = document.getElementById("chatPlaceholder");

        if (chatPlaceholder && !chatPlaceholder.classList.contains("hidden")) {
          chatPlaceholder.classList.add("hidden");
        }

        const messageId = "thinking-" + Date.now();
        if (chatMessages) {
          const messageDiv = document.createElement("div");
          messageDiv.className = "message message-thinking fade-in";
          messageDiv.id = messageId;

          // Create thinking animation with dots
          const thinkingSpan = document.createElement("span");
          thinkingSpan.textContent = "Analyzing document";
          messageDiv.appendChild(thinkingSpan);

          const dotsSpan = document.createElement("span");
          dotsSpan.className = "thinking-dots";
          dotsSpan.textContent = "...";
          messageDiv.appendChild(dotsSpan);

          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          // Animate the dots
          let dots = 0;
          const dotsInterval = setInterval(() => {
            dots = (dots + 1) % 4;
            dotsSpan.textContent = ".".repeat(dots);
          }, 500);

          // Store the interval ID with the message element
          messageDiv.dataset.dotsInterval = dotsInterval;
        }
        return messageId;
      }

      // Remove thinking message
      function removeThinkingMessage(id) {
        const thinkingMessage = document.getElementById(id);
        if (thinkingMessage) {
          // Clear the dots animation interval
          if (thinkingMessage.dataset.dotsInterval) {
            clearInterval(thinkingMessage.dataset.dotsInterval);
          }
          thinkingMessage.remove();
        }
      }

      // Send chat message
      function sendChatMessage() {
        const chatInput = document.getElementById("chatInput");
        if (!chatInput) return;

        const question = chatInput.value.trim();
        if (!question) return;

        addChatMessage(question, "user");
        chatInput.value = "";
        chatInput.style.height = "auto";

        // Disable input while waiting for response
        chatInput.disabled = true;

        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatSendBtn) {
          chatSendBtn.disabled = true;
        }

        const thinkingId = addThinkingMessage();

        if (bridge) {
          bridge.askDocumentQuestion(question);
        } else {
          // Test mode - simulate response
          setTimeout(() => {
            removeThinkingMessage(thinkingId);

            // Sample responses based on questions
            let sampleAnswer = "";
            if (question.toLowerCase().includes("agile")) {
              sampleAnswer = "Agile is a software development approach based on iterative development. It involves breaking tasks into smaller parts and working through a full software development lifecycle in each iteration. The project scope and requirements are defined at the beginning of the development process, with plans regarding the number of iterations, duration, and scope of each iteration clearly defined in advance.";
            } else if (question.toLowerCase().includes("engineering")) {
              sampleAnswer = "According to the document, Engineering applies scientific principles to design and build systems, structures, devices, and processes to solve practical problems. It's one of the three key concepts discussed alongside Science and Technology.";
            } else if (question.toLowerCase().includes("software")) {
              sampleAnswer = "The document defines software as a set of instructions, data, or programs used to operate computers and execute specific tasks. It includes executable programming code, associated libraries, and documentation. The characteristics of software mentioned are that it's intangible, variable, and customizable to meet specific needs.";
            } else {
              sampleAnswer = "Based on the lecture notes, software engineering fundamentals include understanding the differences between programs and software, recognizing the characteristics of software, and applying engineering principles to software development processes. The document also discusses the relationships between science, engineering, and technology as foundational concepts.";
            }

            addChatMessage(sampleAnswer, "assistant");

            // Re-enable input
            chatInput.disabled = false;
            chatInput.focus();

            if (chatSendBtn) {
              chatSendBtn.disabled = false;
            }
          }, 2000);
        }
      }
    </script>
  </body>
</html>

