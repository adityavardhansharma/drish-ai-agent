<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Agent Pro</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Reset and base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #3b82f6;
        --primary-light: #60a5fa;
        --primary-dark: #2563eb;
        --primary-bg: #eff6ff;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --border-radius: 8px;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05);
      }

      html, body {
        height: 100%;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 14px;
        line-height: 1.5;
        color: var(--gray-800);
        background-color: var(--gray-100);
      }

      /* App container */
      .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* Redesigned header */
      .app-header {
        background-color: white;
        border-bottom: 1px solid var(--gray-200);
        padding: 16px;
        box-shadow: var(--shadow-sm);
      }

      .app-logo {
        display: flex;
        align-items: center;
        font-weight: 600;
        font-size: 18px;
        color: var(--primary-dark);
        margin-bottom: 16px;
      }

      .app-logo svg {
        margin-right: 8px;
        fill: var(--primary);
      }

      /* Tab navigation */
      .tab-nav {
        display: flex;
        border-bottom: 2px solid var(--gray-200);
        margin-bottom: 16px;
      }

      .tab-item {
        padding: 10px 20px;
        position: relative;
        cursor: pointer;
        color: var(--gray-600);
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: color 0.2s ease;
        margin-right: 10px;
      }

      .tab-item:hover {
        color: var(--primary);
      }

      .tab-item.active {
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
      }

      /* Control bar with status and actions */
      .control-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-group {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-dot.success {
        background-color: var(--success);
      }

      .status-dot.processing {
        background-color: var(--primary);
      }

      .status-dot.warning {
        background-color: var(--warning);
      }

      .status-dot.error {
        background-color: var(--danger);
      }

      .status-text {
        color: var(--gray-700);
        font-size: 13px;
      }

      .timer-indicator {
        display: flex;
        align-items: center;
        background-color: var(--primary-bg);
        padding: 6px 12px;
        border-radius: 20px;
        color: var(--primary-dark);
        font-size: 13px;
        font-weight: 500;
      }

      .timer-icon {
        margin-right: 6px;
      }

      /* Action buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: var(--border-radius);
        padding: 10px 18px;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.15s ease, transform 0.1s ease;
        white-space: nowrap;
      }

      .btn:active {
        transform: translateY(1px);
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
      }

      .btn-icon {
        margin-right: 8px;
      }

      /* Content area */
      .content-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        padding: 16px;
        gap: 16px;
      }

      .sidebar {
        width: 350px; /* Increased from 280px */
        background-color: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        overflow-y: auto;
        box-shadow: var(--shadow-md);
      }

      .main-content {
        flex: 1;
        background-color: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        overflow-y: auto;
        padding: 20px;
        box-shadow: var(--shadow-md);
      }

      /* Email list */
      .email-list {
        list-style: none;
      }

      .email-item {
        padding: 14px;
        border-bottom: 1px solid var(--gray-200);
        cursor: pointer;
        transition: background-color 0.15s ease;
      }

      .email-item:hover {
        background-color: var(--gray-100);
      }

      .email-item.active {
        background-color: var(--primary-bg);
        border-left: 3px solid var(--primary);
      }

      .email-item-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
      }

      .email-item-content {
        flex: 1;
        overflow: hidden;
      }

      .email-item-header {
        display: flex;
        justify-content: space-between;
      }

      .email-item-sender {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .email-item-time {
        font-size: 12px;
        color: var(--gray-500);
        white-space: nowrap;
      }

      .email-item-subject {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
      }

      .email-item-preview {
        color: var(--gray-600);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 13px;
        margin-top: 2px;
      }

      /* Empty states */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px;
        color: var(--gray-600);
        text-align: center;
        height: 100%;
      }

      .empty-state-icon {
        color: var(--gray-400);
        margin-bottom: 16px;
      }

      .empty-state-title {
        font-weight: 600;
        margin-bottom: 8px;
      }

      .empty-state-description {
        font-size: 13px;
        max-width: 240px;
      }

      /* Email content with improved design */
      .email-content {
        max-width: 800px;
        margin: 0 auto;
      }

      /* Header info card */
      .info-card {
        background: linear-gradient(to right, var(--primary-bg), white);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 24px;
        display: flex;
        gap: 16px;
        align-items: center;
        box-shadow: var(--shadow-sm);
        border-left: 4px solid var(--primary);
      }

      .email-content-avatar {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        background-color: var(--primary);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
      }

      .email-content-info {
        flex: 1;
      }

      .email-content-subject {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--gray-900);
      }

      .email-content-meta {
        font-size: 14px;
        color: var(--gray-600);
      }

      /* Content section cards */
      .email-content-section {
        margin-bottom: 24px;
      }

      /* Section headers with icons */
      .section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        color: var(--primary-dark);
      }

      .section-icon {
        margin-right: 8px;
        stroke: var(--primary);
        stroke-width: 2px;
      }

      /* Card with improved styling */
      .card {
        background-color: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: var(--shadow-sm);
        transition: box-shadow 0.2s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-md);
      }

      /* Summary card */
      .summary-card {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid var(--primary-light);
        box-shadow: var(--shadow-sm);
      }

      /* Key points card */
      .key-point-card {
        display: flex;
        gap: 12px;
        background-color: white;
        border-radius: var(--border-radius);
        padding: 14px;
        margin-bottom: 10px;
        border-top: 1px solid var(--primary-light);
        box-shadow: var(--shadow-sm);
      }

      .key-point-number {
        flex-shrink: 0;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: var(--primary-bg);
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
      }

      /* Reply card */
      .reply-card {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 16px;
        border: 1px solid var(--primary-light);
        border-top: 4px solid var(--primary);
        box-shadow: var(--shadow-md);
      }

      /* Textarea */
      .textarea {
        width: 100%;
        height: 150px;
        padding: 12px;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.5;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        resize: none;
      }

      .textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
      }

      /* Animations */
      @keyframes fadePulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
      }

      .animate-pulse {
        animation: fadePulse 2s infinite ease-in-out;
      }

      /* Loading spinner - simpler for PyQt */
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Redesigned header -->
      <header class="app-header">
        <div class="app-logo">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" />
            <path d="M2 17L12 22L22 17" fill-opacity="0.6" />
            <path d="M2 12L12 17L22 12" fill-opacity="0.8" />
          </svg>
          <span>AI Agent Pro</span>
        </div>

        <div class="tab-nav">
          <div class="tab-item active" onclick="navigateTo('email')">Email Summarizer</div>
          <div class="tab-item" onclick="navigateTo('document')">Document Summary</div>
          <div class="tab-item" onclick="navigateTo('object')">Object Detection</div>
        </div>

        <div class="control-bar">
          <div class="status-group">
            <div id="statusIndicator" class="status-indicator">
              <div class="status-dot success"></div>
              <div class="status-text">Ready to process emails</div>
            </div>

            <div id="timerIndicator" class="timer-indicator">
              <svg class="timer-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span id="timerText">Auto-fetch in 15:00</span>
            </div>
          </div>

          <div class="action-group">
            <button id="fetchBtn" class="btn btn-primary" onclick="startFetch()">
              <span id="fetchSpinner" class="spinner hidden"></span>
              <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 2L11 13"></path>
                <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
              </svg>
              <span id="fetchBtnText">Fetch Mail</span>
            </button>
          </div>
        </div>
      </header>

      <!-- Content Area -->
      <div class="content-container">
        <!-- Sidebar / Email List -->
        <div class="sidebar">
          <div id="emailList" class="email-list">
            <!-- Empty state -->
            <div id="noEmailsMessage" class="empty-state">
              <div class="empty-state-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
              </div>
              <div class="empty-state-title">No emails yet</div>
              <div class="empty-state-description">
                Click "Fetch Mail" to load your inbox
              </div>
            </div>
          </div>
        </div>

        <!-- Main Email Content -->
        <div class="main-content">
          <div id="emailContent" class="empty-state">
            <div class="empty-state-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </div>
            <div class="empty-state-title">Select an email</div>
            <div class="empty-state-description">
              Choose an email from the list to view its summary
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- QWebChannel (local resource, provided by PyQt) -->
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script>
      let bridge;
      let isLoading = false;
      let activeEmailCard = null;
      let emailCount = 0;
      let currentTab = 'email';
      let autoFetchTimer;
      let autoFetchCountdown = 15 * 60; // 15 minutes in seconds

      function startAutoFetchTimer() {
        // Clear any existing timer
        if (autoFetchTimer) {
          clearInterval(autoFetchTimer);
        }

        // Reset countdown to 15 minutes
        autoFetchCountdown = 15 * 60;
        updateTimerDisplay();

        // Start the timer
        autoFetchTimer = setInterval(function() {
          autoFetchCountdown--;

          if (autoFetchCountdown <= 0) {
            // Time to auto-fetch
            clearInterval(autoFetchTimer);
            startFetch();
            // Timer will be restarted after fetch completes
          } else {
            updateTimerDisplay();
          }
        }, 1000);
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(autoFetchCountdown / 60);
        const seconds = autoFetchCountdown % 60;
        const formattedTime = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

        document.getElementById('timerText').textContent = `Auto-fetch in ${formattedTime}`;
      }

      function updateStatusIndicator(status, message) {
        const indicator = document.getElementById('statusIndicator');
        const statusClass = status || 'success';
        const statusMessage = message || 'Ready to process emails';

        indicator.innerHTML = `
          <div class="status-dot ${statusClass}"></div>
          <div class="status-text">${statusMessage}</div>
        `;
      }

      function setActiveTab(tabName) {
        currentTab = tabName;
        const tabs = document.querySelectorAll('.tab-item');
        tabs.forEach(tab => {
          tab.classList.remove('active');
          if (tab.textContent.toLowerCase().includes(tabName)) {
            tab.classList.add('active');
          }
        });

        // Update title for the current tab
        let title = '';
        if (tabName === 'email') title = 'Email Summarizer';
        else if (tabName === 'document') title = 'Document Summary';
        else if (tabName === 'object') title = 'Object Detection';

        updateStatusIndicator('success', `Ready to process ${tabName}s`);
      }

      function clearActiveEmailState() {
        if (activeEmailCard) {
          activeEmailCard.classList.remove("active");
          activeEmailCard = null;
        }
      }

      function setActiveEmailCard(card) {
        clearActiveEmailState();
        card.classList.add("active");
        activeEmailCard = card;
      }

      function getInitials(name) {
        return name
          .split(" ")
          .map((w) => w.charAt(0))
          .join("")
          .toUpperCase()
          .substring(0, 2);
      }

      function getRandomColor() {
        const colors = [
          "#3b82f6", "#2563eb", "#1d4ed8", "#4f46e5",
          "#6366f1", "#8b5cf6", "#a855f7", "#ec4899"
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      function formatDate(dateStr) {
        try {
          const date = new Date(dateStr);
          if (isNaN(date)) return dateStr || "Today";

          const now = new Date();
          const isToday = date.getDate() === now.getDate() &&
                          date.getMonth() === now.getMonth() &&
                          date.getFullYear() === now.getFullYear();

          if (isToday) {
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          }

          return date.toLocaleDateString([], {
            day: '2-digit',
            month: 'short'
          });
        } catch (e) {
          return dateStr || "Today";
        }
      }

      function addEmailSummary(summary, reply, messageId, toEmail, subject) {
        hideLoadingState();
        document.getElementById("noEmailsMessage").style.display = "none";
        const list = document.getElementById("emailList");
        if (!list) {
          console.error("Email list not found.");
          return;
        }

        emailCount++;
        const lines = summary.split("\n");
        let sub = "No Subject",
          from = "Unknown Sender",
          preview = "",
          fromEmail = "",
          date = "";

        lines.forEach((line) => {
          if (line.startsWith("Subject:"))
            sub = line.substring(8).trim();
          if (line.startsWith("From:")) {
            from = line.substring(5).trim();
            const match = from.match(/<([^>]+)>/);
            if (match) {
              fromEmail = match[1];
              from = from.replace(/<[^>]+>/, "").trim();
            }
          }
          if (line.startsWith("Date:")) date = line.substring(5).trim();
          if (line.startsWith("Summary:"))
            preview = line.substring(8).trim();
        });

        const avatarColor = getRandomColor();
        const initials = getInitials(from);
        const formattedDate = formatDate(date);

        const emailItem = document.createElement("div");
        emailItem.className = "email-item";
        emailItem.innerHTML = `
          <div style="display: flex; gap: 12px;">
            <div class="email-item-avatar" style="background-color: ${avatarColor}">
              ${initials}
            </div>
            <div class="email-item-content">
              <div class="email-item-header">
                <div class="email-item-sender">${from}</div>
                <div class="email-item-time">${formattedDate}</div>
              </div>
              <div class="email-item-subject">${sub}</div>
              <div class="email-item-preview">${preview}</div>
            </div>
          </div>
        `;

        emailItem.onclick = function () {
          setActiveEmailCard(this);
          displayEmailContent(
            summary,
            reply,
            messageId,
            toEmail,
            sub,
            from,
            fromEmail,
            date,
            initials,
            avatarColor
          );

          if (bridge && bridge.setCurrentEmail) {
            bridge.setCurrentEmail(
              JSON.stringify({
                message_id: messageId,
                to_email: toEmail,
                subject: sub,
                content: summary
              })
            );
          }
        };

        list.insertBefore(emailItem, list.firstChild);
      }

      function clearEmailsList() {
        const list = document.getElementById("emailList");
        if (list) {
          // Save the empty state element
          const emptyState = document.getElementById("noEmailsMessage");

          // Clear the list but keep the structure
          while (list.firstChild) {
            if (list.firstChild.id === "noEmailsMessage") {
              list.firstChild.style.display = "flex";
              break;
            }
            list.removeChild(list.firstChild);
          }

          // Make sure the empty state is still there
          if (!document.getElementById("noEmailsMessage")) {
            list.appendChild(emptyState);
            emptyState.style.display = "flex";
          }

          emailCount = 0;
        }

        // Reset the main content to empty state
        document.getElementById("emailContent").innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </div>
            <div class="empty-state-title">Select an email</div>
            <div class="empty-state-description">
              Choose an email from the list to view its summary
            </div>
          </div>
        `;

        showLoadingState();
      }

      function showLoadingState() {
        document.getElementById("fetchBtnText").innerText = "Fetching...";
        document.getElementById("fetchSpinner").classList.remove("hidden");
        const fetchBtn = document.getElementById("fetchBtn");
        fetchBtn.disabled = true;
        fetchBtn.style.opacity = "0.7";

        updateStatusIndicator('processing', 'Fetching emails...');
        isLoading = true;
      }

      function hideLoadingState() {
        document.getElementById("fetchBtnText").innerText = "Fetch Mail";
        document.getElementById("fetchSpinner").classList.add("hidden");
        const fetchBtn = document.getElementById("fetchBtn");
        fetchBtn.disabled = false;
        fetchBtn.style.opacity = "1";

        if (emailCount > 0) {
          updateStatusIndicator('success', `${emailCount} emails loaded`);
        } else {
          updateStatusIndicator('warning', 'No emails found');
        }

        isLoading = false;

        // Restart the auto-fetch timer after fetching completes
        startAutoFetchTimer();
      }

      function extractKeyPoints(summaryText) {
        const points = summaryText
          .split(".")
          .filter((s) => s.trim().length > 20)
          .slice(0, 3)
          .map((s) => s.trim());
        return points.length > 0 ? points : ["No key points available in this email."];
      }

      function displayEmailContent(
        summary,
        reply,
        messageId,
        toEmail,
        subject,
        from,
        fromEmail,
        date,
        initials,
        avatarColor
      ) {
        const contentDiv = document.getElementById("emailContent");
        if (!contentDiv) {
          console.error("Email content area not found.");
          return;
        }

        let summaryText = "";
        const lines = summary.split("\n");
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("Summary:")) {
            summaryText = lines[i].substring(8).trim();
            for (let j = i + 1; j < lines.length; j++) {
              if (!lines[j].includes(":")) {
                summaryText += " " + lines[j].trim();
              } else {
                break;
              }
            }
            break;
          }
        }

        const keyPoints = extractKeyPoints(summaryText);
        const formattedDate = formatDate(date);

        contentDiv.innerHTML = `
          <div class="email-content">
            <!-- Header Info Card -->
            <div class="info-card">
              <div class="email-content-avatar" style="background-color: ${avatarColor}">
                ${initials}
              </div>
              <div class="email-content-info">
                <div class="email-content-subject">${subject}</div>
                <div class="email-content-meta">
                  From: ${from} &lt;${fromEmail}&gt; • ${formattedDate}
                </div>
              </div>
            </div>

            <!-- Summary Section -->
            <div class="email-content-section">
              <div class="section-title">
                <svg class="section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Summary
              </div>
              <div class="summary-card">
                <p>${summaryText}</p>
              </div>
            </div>

            <!-- Key Points Section -->
            <div class="email-content-section">
              <div class="section-title">
                <svg class="section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 4-3 4-6.5-2.5 0-4 2.5-7 2.5-4 0-7-8-11-8 0 3 1 5.5 3 5.5 1.5 0 2.5-.5 4-1"></path>
                </svg>
                Key Points
              </div>
              ${keyPoints.map((point, idx) => `
                <div class="key-point-card">
                  <div class="key-point-number">
                    ${idx + 1}
                  </div>
                  <div>${point}</div>
                </div>
              `).join('')}
            </div>

            <!-- Suggested Reply Section -->
            <div class="email-content-section">
              <div class="section-title">
                <svg class="section-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M5 12h14"></path>
                  <path d="M12 5l7 7-7 7"></path>
                </svg>
                Suggested Reply
              </div>
              <div class="reply-card">
                <textarea id="replyText" class="textarea" placeholder="Type your reply here...">${reply}</textarea>

                <button id="sendReplyBtn" class="btn btn-primary" style="margin-top: 16px;" onclick="sendReply()">
                  <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                  Send Reply
                </button>
              </div>
            </div>
          </div>
        `;
      }

      function sendReply() {
        const replyText = document.getElementById("replyText").value;
        if (!replyText) {
          alert("Please enter a reply message");
          return;
        }

        updateStatusIndicator('processing', 'Sending reply...');

        if (bridge && bridge.sendReply) {
          bridge.sendReply(replyText)
            .then(() => {
              updateStatusIndicator('success', 'Reply sent successfully');
            })
            .catch(() => {
              updateStatusIndicator('error', 'Failed to send reply');
            });
        } else {
          console.error("Bridge not available or sendReply missing");
          updateStatusIndicator('error', 'Bridge unavailable');
        }
      }

      function startFetch() {
        if (isLoading) return;

        clearEmailsList();
        if (bridge && bridge.fetchEmails) {
          bridge.fetchEmails()
            .catch(error => {
              console.error("Error fetching emails:", error);
              hideLoadingState();
              updateStatusIndicator('error', 'Failed to fetch emails');
            });
        } else {
          console.error("Bridge not available or fetchEmails missing");
          // For development/testing - add some sample emails
          setTimeout(() => {
            addEmailSummary(
              "Subject: Weekly Team Update\nFrom: John Smith <john@example.com>\nDate: 2023-08-15\nSummary: Please find attached the weekly progress report for our team. Key achievements include launching the new website and completing the Q3 planning documents. Let me know if you have any questions.",
              "Hi John,\n\nThank you for sending the weekly update. I've reviewed the progress report and I'm pleased with the team's achievements, especially the website launch.\n\nLooking forward to discussing the Q3 planning documents in our next meeting.\n\nBest regards,\nAditya",
              "msg123",
              "aditya@example.com",
              "Weekly Team Update"
            );

            addEmailSummary(
              "Subject: Re: Project Proposal\nFrom: Sarah Johnson <sarah@designco.com>\nDate: 2023-08-14\nSummary: I've reviewed your project proposal and would like to schedule a call to discuss some modifications to the timeline. Overall, the approach looks solid, but we may need to adjust the delivery dates to accommodate our team's availability.",
              "Hi Sarah,\n\nI'd be happy to discuss the timeline modifications. How about a call tomorrow at 2 PM your time?\n\nI understand the need for adjustments and am flexible with the delivery dates.\n\nBest regards,\nAditya",
              "msg124",
              "aditya@example.com",
              "Re: Project Proposal"
            );

            addEmailSummary(
              "Subject: Fyhx\nFrom: Aditya Vardhan Sharma <adityavardhan5674@gmail.com>\nDate: 2023-08-15\nSummary: This email contains only a casual greeting: \"Hi how are you\". There is no other information, request, or action item included in the email body. The subject line \"Fyhx\" appears unrelated to the content.",
              "Hi Aditya,\n\nI'm doing well, thank you. How can I assist you today?\n\nBest regards,\nAI Assistant",
              "msg125",
              "assistant@example.com",
              "Fyhx"
            );

            hideLoadingState();
          }, 1500);
        }
      }

      function navigateTo(page) {
        setActiveTab(page);

        if (typeof qt !== "undefined" && qt.webChannelTransport) {
          new QWebChannel(qt.webChannelTransport, function (channel) {
            if (channel.objects.bridge && channel.objects.bridge.agentSelected) {
              channel.objects.bridge.agentSelected(page);
            }
          });
        } else {
          console.log("QWebChannel not available or running outside application");
        }
      }

      // Initialize the bridge once the DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Start the auto-fetch timer
        startAutoFetchTimer();

        if (typeof qt !== "undefined" && qt.webChannelTransport) {
          new QWebChannel(qt.webChannelTransport, function (channel) {
            bridge = channel.objects.bridge;
            console.log("Bridge connected successfully");

            // Auto-fetch emails at startup
            startFetch();
          });
        } else {
          console.log("QWebChannel not available, running in development mode");

          // Development mode simulation - auto-fetch at startup
          startFetch();
        }

        // Add auto-fetch functionality - every 15 minutes
        setInterval(function() {
          if (!isLoading) {
            startFetch();
          }
        }, 15 * 60 * 1000); // 15 minutes in milliseconds
      });
    </script>
  </body>
</html>
