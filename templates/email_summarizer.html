<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>AI Agent Pro - Email Summarizer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #3b82f6;
        --primary-light: #60a5fa;
        --primary-dark: #2563eb;
        --primary-bg: #eff6ff;
        --primary-bg-hover: #dbeafe;
        --success: #10b981;
        --success-light: #d1fae5;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --border-radius: 8px;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        --transition-fast: 150ms ease;
        --transition-normal: 250ms ease;
        --transition-slow: 350ms ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 14px;
        line-height: 1.5;
        color: var(--gray-800);
        background-color: var(--gray-100);
      }

      .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      .app-header {
        background-color: white;
        border-bottom: 1px solid var(--gray-200);
        padding: 16px;
        box-shadow: var(--shadow-sm);
        z-index: 10;
      }

      .app-logo {
        display: flex;
        align-items: center;
        font-weight: 600;
        font-size: 18px;
        color: var(--primary-dark);
        margin-bottom: 16px;
        transition: transform var(--transition-fast);
      }

      .app-logo:hover {
        transform: translateY(-1px);
      }

      .app-logo svg {
        margin-right: 8px;
        fill: var(--primary);
      }

      .tab-nav {
        display: flex;
        border-bottom: 2px solid var(--gray-200);
        margin-bottom: 16px;
      }

      .tab-item {
        position: relative;
        padding: 10px 20px;
        cursor: pointer;
        color: var(--gray-600);
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: color var(--transition-fast);
        margin-right: 10px;
        user-select: none;
      }

      .tab-item:hover {
        color: var(--primary);
      }

      .tab-item.active {
        color: var(--primary);
      }

      .tab-item.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--primary);
        transform-origin: bottom;
        animation: slideIn 0.3s ease forwards;
      }

      @keyframes slideIn {
        from {
          transform: scaleX(0);
        }
        to {
          transform: scaleX(1);
        }
      }

      .control-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-group {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        transition: all var(--transition-normal);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        transition: all var(--transition-normal);
      }

      .status-dot.success {
        background-color: var(--success);
        box-shadow: 0 0 0 3px var(--success-light);
      }

      .status-dot.processing {
        background-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-bg);
        animation: pulse 2s infinite;
      }

      .status-dot.warning {
        background-color: var(--warning);
        box-shadow: 0 0 0 3px var(--warning-light);
      }

      .status-dot.error {
        background-color: var(--danger);
        box-shadow: 0 0 0 3px var(--danger-light);
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
        }
        70% {
          box-shadow: 0 0 0 5px rgba(59, 130, 246, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
      }

      .status-text {
        color: var(--gray-700);
        font-size: 13px;
        font-weight: 500;
      }

      .timer-indicator {
        display: flex;
        align-items: center;
        background-color: var(--primary-bg);
        padding: 6px 12px;
        border-radius: 20px;
        color: var(--primary-dark);
        font-size: 13px;
        font-weight: 500;
        transition: background-color var(--transition-fast);
      }

      .timer-indicator:hover {
        background-color: var(--primary-bg-hover);
      }

      .timer-icon {
        margin-right: 6px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: var(--border-radius);
        padding: 10px 18px;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
        white-space: nowrap;
        position: relative;
        overflow: hidden;
      }

      .btn::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        background-image: radial-gradient(
          circle,
          #fff 10%,
          transparent 10.01%
        );
        background-repeat: no-repeat;
        background-position: 50%;
        transform: scale(10, 10);
        opacity: 0;
        transition: transform 0.5s, opacity 1s;
      }

      .btn:active::after {
        transform: scale(0, 0);
        opacity: 0.3;
        transition: 0s;
      }

      .btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
      }

      .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
      }

      .btn-icon {
        margin-right: 8px;
      }

      .content-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        padding: 16px;
        gap: 16px;
        height: calc(100vh - 130px);
      }

      .sidebar {
        width: 350px;
        background-color: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        overflow-y: auto;
        box-shadow: var(--shadow-md);
        transition: box-shadow var(--transition-normal);
        scrollbar-width: thin;
        scrollbar-color: var(--gray-300) transparent;
        flex-shrink: 0;
      }

      .sidebar:hover {
        box-shadow: var(--shadow-lg);
      }

      .sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar::-webkit-scrollbar-track {
        background: transparent;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background-color: var(--gray-300);
        border-radius: 10px;
      }

      .email-list {
        list-style: none;
      }

      .email-item {
        padding: 14px;
        border-bottom: 1px solid var(--gray-200);
        cursor: pointer;
        transition: all var(--transition-fast);
        position: relative;
      }

      .email-item:hover {
        background-color: var(--gray-50);
      }

      .email-item.active {
        background-color: var(--primary-bg);
      }

      .email-item.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background-color: var(--primary);
      }

      .email-item-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        transition: transform var(--transition-fast);
      }

      .email-item:hover .email-item-avatar {
        transform: scale(1.05);
      }

      .email-item-content {
        flex: 1;
        overflow: hidden;
      }

      .email-item-header {
        display: flex;
        justify-content: space-between;
      }

      .email-item-sender {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .email-item-time {
        font-size: 12px;
        color: var(--gray-500);
        white-space: nowrap;
      }

      .email-item-subject {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
      }

      .email-item-preview {
        color: var(--gray-600);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 13px;
        margin-top: 2px;
      }

      .main-content {
        flex: 1;
        background-color: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        transition: box-shadow var(--transition-normal);
        display: flex;
        flex-direction: column;
      }

      .main-content:hover {
        box-shadow: var(--shadow-lg);
      }

      .main-content::-webkit-scrollbar {
        width: 6px;
      }

      .main-content::-webkit-scrollbar-track {
        background: transparent;
      }

      .main-content::-webkit-scrollbar-thumb {
        background-color: var(--gray-300);
        border-radius: 10px;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px;
        color: var(--gray-600);
        text-align: center;
        height: 100%;
        animation: fadeIn 0.5s ease forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .empty-state-icon {
        color: var(--gray-400);
        margin-bottom: 16px;
      }

      .empty-state-title {
        font-weight: 600;
        margin-bottom: 8px;
      }

      .empty-state-description {
        font-size: 13px;
        max-width: 240px;
      }

      /* Updated email-content: set as a flex child so that its header stays fixed and content scrolls */
      .email-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
      }

      .email-header {
        background-color: var(--primary-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 24px;
        border-left: 4px solid var(--primary);
        box-shadow: var(--shadow-sm);
        transition: transform var(--transition-normal),
          box-shadow var(--transition-normal);
      }

      .email-sender {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      .avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        margin-right: 16px;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform var(--transition-normal);
      }

      .email-subject {
        font-size: 20px;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 4px;
      }

      .email-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 14px;
      }

      .email-section {
        margin-bottom: 24px;
        animation: fadeIn 0.5s ease forwards;
      }

      .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 16px;
      }

      .section-icon {
        margin-right: 8px;
        color: var(--primary);
      }

      .summary-content {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 20px;
        border: 1px solid var(--gray-200);
        border-left: 4px solid var(--primary-light);
        box-shadow: var(--shadow-sm);
        line-height: 1.6;
        color: var(--gray-800);
        transition: transform var(--transition-normal),
          box-shadow var(--transition-normal);
        overflow-wrap: break-word;
      }

      .summary-content p {
        margin: 0;
      }

      .summary-content:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .key-points {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .key-point {
        display: flex;
        gap: 12px;
        background-color: white;
        border-radius: var(--border-radius);
        padding: 14px;
        border: 1px solid var(--gray-200);
        border-top: 2px solid var(--primary-light);
        box-shadow: var(--shadow-sm);
        transition: transform var(--transition-normal),
          box-shadow var(--transition-normal);
      }

      .key-point:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .point-number {
        flex-shrink: 0;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: var(--primary-bg);
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        transition: transform var(--transition-normal),
          background-color var(--transition-fast);
      }

      .key-point:hover .point-number {
        transform: scale(1.1);
        background-color: var(--primary);
        color: white;
      }

      .reply-box {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 16px;
        border: 1px solid var(--primary-light);
        border-top: 4px solid var(--primary);
        box-shadow: var(--shadow-md);
        transition: transform var(--transition-normal),
          box-shadow var(--transition-normal);
      }

      .reply-box:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .textarea {
        width: 100%;
        height: 150px;
        padding: 12px;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.5;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        resize: none;
        transition: border-color var(--transition-fast),
          box-shadow var(--transition-fast);
      }

      .textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
      }

      .reply-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
      }

      .reply-info {
        font-size: 13px;
        color: var(--gray-500);
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.5s ease forwards;
      }

      .animate-slide-in-right {
        animation: slideInRight 0.5s ease forwards;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <header class="app-header">
        <div class="app-logo">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M12 2L2 7L12 12L22 7L12 2Z" />
            <path d="M2 17L12 22L22 17" fill-opacity="0.6" />
            <path d="M2 12L12 17L22 12" fill-opacity="0.8" />
          </svg>
          <span>AI Agent Pro</span>
        </div>
        <div class="tab-nav">
          <div
            class="tab-item active"
            onclick="navigateTo('email')"
          >
            Email Summarizer
          </div>
          <div
            class="tab-item"
            onclick="navigateTo('document')"
          >
            Document Summary
          </div>
          <div
            class="tab-item"
            onclick="navigateTo('object')"
          >
            Object Detection
          </div>
        </div>
        <div class="control-bar">
          <div class="status-group">
            <div id="statusIndicator" class="status-indicator">
              <div class="status-dot success"></div>
              <div class="status-text">
                Ready to process emails
              </div>
            </div>
            <div id="timerIndicator" class="timer-indicator">
              <svg
                class="timer-icon"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span id="timerText">Auto-fetch in 15:00</span>
            </div>
          </div>
          <div class="action-group">
            <button
              id="fetchBtn"
              class="btn btn-primary"
              onclick="startFetch()"
            >
              <span id="fetchSpinner" class="spinner hidden"></span>
              <svg
                class="btn-icon"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M22 2L11 13"></path>
                <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
              </svg>
              <span id="fetchBtnText">Fetch Mail</span>
            </button>
          </div>
        </div>
      </header>
      <div class="content-container">
        <div class="sidebar">
          <div id="emailList" class="email-list">
            <div id="noEmailsMessage" class="empty-state">
              <div class="empty-state-icon">
                <svg
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
              </div>
              <div class="empty-state-title">
                No emails yet
              </div>
              <div class="empty-state-description">
                Click "Fetch Mail" to load your inbox
              </div>
            </div>
          </div>
        </div>
        <div class="main-content">
          <div id="emailContent" class="empty-state">
            <div class="empty-state-icon">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"
                ></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </div>
            <div class="empty-state-title">
              Select an email
            </div>
            <div class="empty-state-description">
              Choose an email from the list to view its summary
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let isLoading = false;
      let emailCount = 0;
      let autoFetchTimer;
      let autoFetchCountdown = 15 * 60;
      let currentTab = "email";
      let currentEmailData = {};
      let activeEmailItem = null;

      function navigateTo(page) {
        setActiveTab(page);
        window.location.href = "/" + page;
      }

      function setActiveTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll(".tab-item").forEach((tab) => {
          tab.classList.remove("active");
          if (tab.textContent.toLowerCase().includes(tabName)) {
            tab.classList.add("active");
          }
        });
        updateStatusIndicator("success", `Ready to process ${tabName}s`);
      }

      function updateStatusIndicator(status, message) {
        const indicator = document.getElementById("statusIndicator");
        indicator.innerHTML = `<div class="status-dot ${status}"></div>
          <div class="status-text">${message}</div>`;
      }

      function startAutoFetchTimer() {
        if (autoFetchTimer) clearInterval(autoFetchTimer);
        autoFetchCountdown = 15 * 60;
        updateTimerDisplay();
        autoFetchTimer = setInterval(() => {
          autoFetchCountdown--;
          if (autoFetchCountdown <= 0) {
            clearInterval(autoFetchTimer);
            startFetch();
          } else {
            updateTimerDisplay();
          }
        }, 1000);
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(autoFetchCountdown / 60);
        const seconds = autoFetchCountdown % 60;
        document.getElementById("timerText").textContent =
          `Auto-fetch in ${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
      }

      function showLoadingState() {
        document.getElementById("fetchBtnText").innerText = "Fetching...";
        document.getElementById("fetchSpinner").classList.remove("hidden");
        document.getElementById("fetchBtn").disabled = true;
        updateStatusIndicator("processing", "Fetching emails...");
        isLoading = true;
      }

      function hideLoadingState() {
        document.getElementById("fetchBtnText").innerText = "Fetch Mail";
        document.getElementById("fetchSpinner").classList.add("hidden");
        document.getElementById("fetchBtn").disabled = false;
        updateStatusIndicator(
          emailCount > 0 ? "success" : "warning",
          emailCount > 0 ? `${emailCount} emails loaded` : "No emails found"
        );
        isLoading = false;
        startAutoFetchTimer();
      }

      function clearEmailsList() {
        const list = document.getElementById("emailList");
        if (list) {
          const emptyState = document.getElementById("noEmailsMessage");
          while (list.firstChild) {
            if (list.firstChild.id === "noEmailsMessage") {
              list.firstChild.style.display = "flex";
              break;
            }
            list.removeChild(list.firstChild);
          }
          if (!document.getElementById("noEmailsMessage")) {
            list.appendChild(emptyState);
            emptyState.style.display = "flex";
          }
          emailCount = 0;
        }
        document.getElementById("emailContent").innerHTML = `<div class="empty-state">
            <div class="empty-state-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </div>
            <div class="empty-state-title">Select an email</div>
            <div class="empty-state-description">Choose an email from the list to view its summary</div>
          </div>`;
      }

      function addEmailSummary(summary, reply, messageId, toEmail, subject) {
        hideLoadingState();
        document.getElementById("noEmailsMessage").style.display = "none";
        const list = document.getElementById("emailList");
        if (!list) return console.error("Email list not found.");
        emailCount++;

        let sub = "No Subject", from = "Unknown Sender", fromEmail = "",
          preview = "", date = "";
        summary.split("\n").forEach((line) => {
          if (line.startsWith("Subject:")) sub = line.substring(8).trim();
          if (line.startsWith("From:")) {
            const parts = line.substring(5).trim().split("<");
            from = parts[0].trim();
            if (parts.length > 1) {
              fromEmail = parts[1].replace(">", "").trim();
            }
          }
          if (line.startsWith("Date:")) date = line.substring(5).trim();
          if (line.startsWith("Summary:")) preview = line.substring(8).trim();
        });

        const avatarColor =
          "#" + Math.floor(Math.random() * 16777215).toString(16);
        const initials = from
          .split(" ")
          .map((w) => w.charAt(0))
          .join("")
          .toUpperCase()
          .substring(0, 2);
        const formattedDate = date || "Today";

        const emailItem = document.createElement("div");
        emailItem.className = "email-item animate-fade-in-up";
        emailItem.style.animationDelay = emailCount * 0.05 + "s";
        emailItem.innerHTML = `
          <div style="display: flex; gap: 12px;">
            <div class="email-item-avatar" style="background-color: ${avatarColor}">
              ${initials}
            </div>
            <div class="email-item-content">
              <div class="email-item-header">
                <div class="email-item-sender">${from}</div>
                <div class="email-item-time">${formattedDate}</div>
              </div>
              <div class="email-item-subject">${sub}</div>
              <div class="email-item-preview">${preview}</div>
            </div>
          </div>`;

        emailItem.onclick = function () {
          if (activeEmailItem) {
            activeEmailItem.classList.remove("active");
          }
          activeEmailItem = emailItem;
          emailItem.classList.add("active");

          currentEmailData = {
            message_id: messageId,
            to_email: toEmail,
            subject: sub,
            content: summary,
            from: from,
            from_email: fromEmail,
          };

          displayEmailContent(
            summary,
            reply,
            messageId,
            toEmail,
            sub,
            from,
            fromEmail,
            date,
            initials,
            avatarColor
          );
        };

        list.insertBefore(emailItem, list.firstChild);
      }

      function displayEmailContent(
        summary,
        reply,
        messageId,
        toEmail,
        subject,
        from,
        fromEmail,
        date,
        initials,
        avatarColor
      ) {
        const contentDiv = document.getElementById("emailContent");
        if (!contentDiv)
          return console.error("Email content area not found.");

        let summaryText = "";
        const lines = summary.split("\n");
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("Summary:")) {
            summaryText = lines[i].substring(8).trim();
            for (let j = i + 1; j < lines.length; j++) {
              if (!lines[j].includes(":"))
                summaryText += " " + lines[j].trim();
              else break;
            }
            break;
          }
        }

        const keyPoints = summaryText
          .split(".")
          .filter((s) => s.trim().length > 20)
          .slice(0, 3);
        const formattedDate = date || "Today";

        contentDiv.innerHTML = `
          <div class="email-content animate-slide-in-right">
            <div class="email-header">
              <div class="email-sender">
                <div class="avatar" style="background-color: ${avatarColor}">
                  ${initials}
                </div>
                <div>
                  <div class="email-subject">${subject}</div>
                </div>
              </div>
              <div class="email-meta">
                <div class="meta-label">From:</div>
                <div class="meta-value">${from} ${
          fromEmail ? `<${fromEmail}>` : ""
        }</div>
                <div class="meta-label">To:</div>
                <div class="meta-value">${toEmail}</div>
                <div class="meta-label">Date:</div>
                <div class="meta-value">${formattedDate}</div>
              </div>
            </div>

            <div class="email-section">
              <div class="section-header">
                <svg class="section-icon" width="18" height="18" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Summary
              </div>
              <div class="summary-content">
                <p>${summaryText}</p>
              </div>
            </div>

            <div class="email-section">
              <div class="section-header">
                <svg class="section-icon" width="18" height="18" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 4-3 4-6.5-2.5 0-4 2.5-7 2.5-4 0-7-8-11-8 0 3 1 5.5 3 5.5 1.5 0 2.5-.5 4-1"></path>
                </svg>
                Key Points
              </div>
              <div class="key-points">
                ${keyPoints
                  .map(
                    (point, idx) => `
                  <div class="key-point" style="animation-delay: ${
                    idx * 0.1
                  }s">
                    <div class="point-number">${idx + 1}</div>
                    <div>${point}</div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>

            <div class="email-section">
              <div class="section-header">
                <svg class="section-icon" width="18" height="18" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path d="M5 12h14"></path>
                  <path d="M12 5l7 7-7 7"></path>
                </svg>
                Suggested Reply
              </div>
              <div class="reply-box">
                <textarea id="replyText" class="textarea" placeholder="Type your reply here...">
                  ${reply}
                </textarea>
                <div class="reply-actions">
                  <div class="reply-info">Replying to ${from}</div>
                  <button id="sendReplyBtn" class="btn btn-primary" onclick="sendReply()">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                      stroke-linejoin="round">
                      <line x1="22" y1="2" x2="11" y2="13"></line>
                      <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    Send Reply
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function sendReply() {
        const replyText = document.getElementById("replyText").value;
        if (!replyText) {
          alert("Please enter a reply message");
          return;
        }

        const sendBtn = document.getElementById("sendReplyBtn");
        const originalBtnText = sendBtn.innerHTML;

        sendBtn.innerHTML = `
          <span class="spinner"></span>
          Sending...
        `;
        sendBtn.disabled = true;

        updateStatusIndicator("processing", "Sending reply...");

        fetch("/api/emails/reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            reply_text: replyText,
            message_id: currentEmailData.message_id,
            to_email:
              currentEmailData.from_email || currentEmailData.to_email,
            subject: "Re: " + currentEmailData.subject,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              sendBtn.innerHTML = `
              <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24"
                fill="none" stroke="white" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Sent!
            `;
              sendBtn.style.backgroundColor = "var(--success)";
              updateStatusIndicator("success", "Reply sent successfully");
              setTimeout(() => {
                sendBtn.innerHTML = originalBtnText;
                sendBtn.style.backgroundColor = "";
                sendBtn.disabled = false;
              }, 2000);
            } else {
              sendBtn.innerHTML = originalBtnText;
              sendBtn.disabled = false;
              updateStatusIndicator(
                "error",
                data.message || "Failed to send reply"
              );
            }
          })
          .catch((error) => {
            console.error(error);
            sendBtn.innerHTML = originalBtnText;
            sendBtn.disabled = false;
            updateStatusIndicator("error", "Failed to send reply");
          });
      }

      function startFetch() {
        if (isLoading) return;
        clearEmailsList();
        showLoadingState();

        setTimeout(() => {
          const evtSource = new EventSource("/api/emails/fetch");

          evtSource.onmessage = function (event) {
            try {
              let data = JSON.parse(event.data);
              if (data.type === "email_summary") {
                const d = data.data;
                addEmailSummary(
                  d.summary,
                  d.reply,
                  d.message_id,
                  d.to_email,
                  d.subject
                );
              } else if (data.type === "status") {
                updateStatusIndicator("processing", data.message);
              } else if (data.type === "progress") {
                // Optional: Handle progress messages
              } else if (data.type === "completed") {
                updateStatusIndicator("success", data.message);
                evtSource.close();
                hideLoadingState();
              } else if (data.type === "error") {
                updateStatusIndicator("error", data.message);
                evtSource.close();
                hideLoadingState();
              }
            } catch (e) {
              console.error("Error parsing event data", e);
            }
          };

          evtSource.onerror = function (event) {
            console.error("EventSource error", event);
            evtSource.close();
            hideLoadingState();
            updateStatusIndicator("error", "Error fetching emails");
          };
        }, 800);

        setTimeout(() => {
          const demoEmails = [
            {
              summary:
                "From: John Smith <john.smith@example.com>\nTo: you@example.com\nSubject: Quarterly Business Review\nDate: Today, 10:45 AM\nSummary: I'd like to schedule our quarterly business review for next week. Please let me know your availability on Tuesday or Wednesday afternoon. We need to discuss the Q3 results and plan for Q4 initiatives.",
              reply:
                "Hi John,\n\nThanks for reaching out about the quarterly business review. I'm available on Wednesday afternoon from 2-4pm. Would that work for you?\n\nLooking forward to discussing our Q3 results and planning our Q4 initiatives.\n\nBest regards,",
              message_id: "msg123",
              to_email: "you@example.com",
              subject: "Quarterly Business Review",
            },
            {
              summary:
                "From: Sarah Johnson <sarah.j@techcorp.com>\nTo: you@example.com\nSubject: Project Deadline Extension\nDate: Yesterday, 4:22 PM\nSummary: Due to unexpected technical challenges with the database migration, we need to request a two-week extension on the project deadline. The team has been working overtime but we've encountered issues with data integrity that require additional testing.",
              reply:
                "Hi Sarah,\n\nThank you for letting me know about the challenges with the database migration. I understand these technical issues can be complex.\n\nA two-week extension should be fine. Please send me a revised timeline with the updated milestones so I can update our stakeholders.\n\nLet me know if you need any additional resources to help resolve the data integrity issues.\n\nRegards,",
              message_id: "msg456",
              to_email: "you@example.com",
              subject: "Project Deadline Extension",
            },
            {
              summary:
                "From: Marketing Team <marketing@company.org>\nTo: all-staff@company.org\nSubject: New Brand Guidelines Released\nDate: Monday, 9:00 AM\nSummary: The marketing department has released updated brand guidelines effective immediately. All presentations, documents, and external communications should follow the new color palette, typography, and logo usage rules. Training sessions will be held this Thursday and Friday.",
              reply:
                "Hello Marketing Team,\n\nThank you for sharing the updated brand guidelines. I've reviewed the changes and will implement them in my upcoming presentations and documents.\n\nI'd like to attend the training session on Thursday. Could you please confirm the time and location?\n\nBest regards,",
              message_id: "msg789",
              to_email: "all-staff@company.org",
              subject: "New Brand Guidelines Released",
            },
          ];

          if (emailCount === 0) {
            demoEmails.forEach((email) => {
              addEmailSummary(
                email.summary,
                email.reply,
                email.message_id,
                email.to_email,
                email.subject
              );
            });
            hideLoadingState();
          }
        }, 3000);
      }

      document.addEventListener("DOMContentLoaded", function () {
        startAutoFetchTimer();

        setTimeout(() => {
          startFetch();
        }, 500);

        setInterval(function () {
          if (!isLoading) startFetch();
        }, 15 * 60 * 1000);
      });
    </script>
  </body>
</html>
